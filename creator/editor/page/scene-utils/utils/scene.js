"use strict";const e=require("../lib/tasks"),t=require("./node"),n=require("./animation"),o=require("./prefab"),{vec3:c,quat:r,mat4:i}=cc.vmath;let d=null,a=null,s=function(e){return Editor.Utils.arrayCmpFilter(e,(e,t)=>e===t?0:t.isChildOf(e)?1:e.isChildOf(t)?-1:0)},l=function(e,n,o,c,r){let i;n&&(i=cc.engine.getInstanceById(n)),i||(i=cc.director.getScene()),Editor.Selection.unselect("node",Editor.Selection.curSelection("node"),!1);let d=e.map(e=>{return new Promise(function(n,r){t.createNodeFromAsset(e,(e,t)=>{if(e)return r(e);let d;if(t){if(d=t.uuid,i&&(t.parent=i),c){t.parent=null;let e=cc.engine.getInstanceById(c).getSiblingIndex();t.parent=i,t.setSiblingIndex(e)}_Scene.Undo.recordCreateNode(d)}d&&Editor.Selection.select("node",d,!1,!1),cc.engine.repaintInEditMode(),o&&o.unlinkPrefab&&(t&&t.parent&&t.parent._prefab||_Scene.breakPrefabInstance([d])),n(t)})}).catch(t=>{Editor.failed(`Failed to drop asset ${Editor.remote.assetdb.uuidToUrl(e)}, message: ${t.stack}`)})});Promise.all(d).then(e=>{_Scene.Undo.commit(),Editor.Selection.confirm(),r&&r(null,e)}).catch(e=>{_Scene.Undo.commit(),Editor.Selection.cancel(),r&&r(e)})},u=function(e,t,n){if(t._disallowMultiple){let o=e.getComponent(t._disallowMultiple);if(o){let e,c;return e=o.constructor===t?Editor.T("MESSAGE.scene.contain_same_component"):Editor.T("MESSAGE.scene.contain_derive_component",{className:cc.js.getClassName(o)}),c=n?"MESSAGE.scene.cant_add_required_component":"MESSAGE.scene.cant_add_component",Editor.Dialog.messageBox({type:"warning",buttons:["OK"],title:Editor.T("MESSAGE.warning"),message:Editor.T(c,{className:cc.js.getClassName(t)}),detail:e,noLink:!0}),!1}}let o=t._requireComponent;return!(o&&!e.getComponent(o))||u(e,o,!0)},m=function(e){var t=e.__asyncStates;for(var n in t){if("start"===t[n].state)return!0}return!1};module.exports={createDefaultScene:function(){let e=new cc.Scene,t=new cc.Node("Canvas");return t.parent=e,t.addComponent(cc.Canvas),e},loadScene:function(e,t){cc.director.runSceneImmediate(e),Editor.Ipc.sendToMain("scene:set-current-scene",null,t&&function(e,...n){t(e,...n)})},loadSceneByUuid:function(t,n){e.push({name:"load-scene-by-uuid",run(e){cc.director._loadSceneByUuid(t,n=>{if(n)return e&&e(n),void 0;Editor.Ipc.sendToMain("scene:set-current-scene",t,t=>{e&&e(t)})})}},n)},isAnyChildClassOf:function(e,...t){for(var n=0;n<t.length;++n)if(cc.js.isChildClassOf(e,t[n]))return!0;return!1},copyNodes:function(e){let t=e.map(e=>cc.engine.getInstanceById(e)).filter(e=>!!e);t=function(e){return Editor.Utils.arrayCmpFilter(e,(e,t)=>e===t?0:t.isChildOf(e)?1:e.isChildOf(t)?-1:0)}(t).filter(e=>!!e);let n={sceneId:cc.director.getScene().uuid,nodes:{}};t.forEach(e=>{n.nodes[e.uuid]=cc.instantiate(e)}),d=n},pasteNodes:function(e){if(!d)return;let t;e&&(t=cc.engine.getInstanceById(e)),t||(t=cc.director.getScene());let n=[];for(let e in d.nodes){let o=cc.instantiate(d.nodes[e]);o.parent=t,n.push(o.uuid),_Scene.Undo.recordCreateNode(o.uuid)}_Scene.Undo.commit(),Editor.Selection.select("node",n)},duplicateNodes:function(e){if(n.STATE.RECORD)return;let t=e.map(e=>cc.engine.getInstanceById(e));t=t.filter(e=>!!e);let o=[];(t=s(t)).forEach(e=>{let t=cc.instantiate(e);t.parent=e.parent;let n=e.getSiblingIndex();t.name=e.name&&e.name.endsWith(" copy")?e.name:`${e.name} copy`,t.setSiblingIndex(n+1),o.push(t.uuid),_Scene.Undo.recordCreateNode(t.uuid)}),_Scene.Undo.commit(),Editor.Selection.select("node",o)},moveNodes:function(e,t,n){let o,c=function(e){return e._parent?e._parent._children.indexOf(e):-1};o=t?cc.engine.getInstanceById(t):cc.director.getScene();let r=n?cc.engine.getInstanceById(n):null;o&&(e.forEach(e=>{let t=cc.engine.getInstanceById(e);if(t&&!o.isChildOf(t))if(_Scene.Undo.recordMoveNode(e),t.parent!==o){let e=t.getWorldPosition(cc.v3()),n=t.getWorldRotation(cc.quat()),i=t.getWorldScale(cc.v3());t.parent=o,t.setWorldPosition(e),t.setWorldRotation(n),t.setWorldScale(i),_Scene.adjustNodePosition(t,5),_Scene.adjustNodeScale(t,5),t.parent=null;let d=r?c(r):-1;t.parent=o,t.setSiblingIndex(d)}else{let e=c(t),n=r?c(r):-1;e<n&&(n-=1),t.setSiblingIndex(n)}}),_Scene.Undo.commit())},hasCopiedComponent:function(){return!!a},copyComponent:function(e){let t=cc.engine.getInstanceById(e);t&&(a=cc.instantiate(t,!0))},pasteComponent:function(e,t){let n=cc.engine.getInstanceById(e);if(n&&a){let e=cc.instantiate(a,!0);n._addComponentAt(e,t),cc.director._nodeActivator.resetComp(e),_Scene.Undo.recordAddComponent(n.uuid,e,t,"Paste Component"),_Scene.Undo.commit()}},createNodes:l,createNodesAt:function(e,t,n,o){l(e,null,o,null,(e,o)=>{if(e)return Editor.error(e),void 0;o.forEach(e=>{e&&(e.setPosition(_Scene.view.pixelToScene(cc.v2(t,n))),_Scene.adjustNodePosition(e))})})},createNodeByClassID:function(e,n,o,c){let r;o&&(r=cc.engine.getInstanceById(o),c&&(r=r.parent)),r||(r=cc.director.getScene());t.createNodeFromClass(n,(t,n)=>{if(t)return Editor.error(t);n.name=e,n.parent=r,cc.engine.repaintInEditMode(),Editor.Selection.select("node",n.uuid,!0,!0),_Scene.Undo.recordCreateNode(n.uuid),_Scene.Undo.commit()})},createNodeByPrefab:function(e,n,c,r){let i;t.createNodeFromAsset(n,(t,n)=>{if(t)return Editor.error(t),void 0;o.unlinkPrefab(n),n.name=e,c&&(i=cc.engine.getInstanceById(c),r&&(i=i.parent)),i||(i=cc.director.getScene());var d=n.getComponent(cc.Canvas);d&&_Scene._applyCanvasPreferences(d),n.parent=i,cc.engine.repaintInEditMode(),Editor.Selection.select("node",n.uuid,!0,!0),_Scene.Undo.recordCreateNode(n.uuid),_Scene.Undo.commit()})},deleteNodes:function(e){if(n.STATE.RECORD)return;let o=[];for(let t=0;t<e.length;++t){let n=cc.engine.getInstanceById(e[t]);n&&o.push(n)}s(o).forEach(e=>{t._destroyForUndo(e,()=>{_Scene.Undo.recordDeleteNode(e.uuid)})}),_Scene.Undo.commit(),Editor.Selection.unselect("node",e,!0)},addComponent:function(e,t){let o=Editor.Utils.UuidUtils.isUuid(t),c=cc.js._getClassById(t);if(!c)return o?(Editor.error(`Can not find cc.Component in the script ${t}.`),void 0):(Editor.error(`Failed to get component ${t}`),void 0);let r=cc.engine.getInstanceById(e);if(!r)return Editor.error(`Can not find node ${e}`),void 0;if(!u(r,c))return;let i=r.addComponent(c);i&&(cc.director._nodeActivator.resetComp(i),_Scene.Undo.recordAddComponent(e,i,r._components.indexOf(i)),_Scene.Undo.commit(),n.onAddComponent(r,i))},removeComponent:function(e,o){let c=cc.engine.getInstanceById(o);if(!c)return Editor.error(`Can not find component ${o}`),void 0;if(n.STATE.RECORD&&c instanceof cc.Animation)return Editor.Dialog.messageBox({type:"warning",buttons:[Editor.T("MESSAGE.ok")],title:Editor.T("MESSAGE.warning"),message:Editor.T("MESSAGE.scene.cant_remove_component",{className:cc.js.getClassName(c)}),detail:Editor.T("MESSAGE.scene.cant_remove_component_detail",{className:Editor.T("MAIN_MENU.panel.timeline")}),noLink:!0}),void 0;let r=cc.engine.getInstanceById(e);if(!r)return Editor.error(`Can not find node ${e}`),void 0;let i=r._getDependComponent(c);if(i)return Editor.Dialog.messageBox({type:"warning",buttons:[Editor.T("MESSAGE.ok")],title:Editor.T("MESSAGE.warning"),message:Editor.T("MESSAGE.scene.cant_remove_component",{className:cc.js.getClassName(c)}),detail:Editor.T("MESSAGE.scene.cant_remove_component_detail",{className:cc.js.getClassName(i)}),noLink:!0}),void 0;t._destroyForUndo(c,()=>{_Scene.Undo.recordRemoveComponent(e,c,r._components.indexOf(c))}),_Scene.Undo.commit(),n.onRemoveComponent(r,c)},createProperty:function(e,t,n){const o=Editor.require("unpack://engine-dev/cocos2d/core/platform/CCClass").getDefault;let c=cc.engine.getInstanceById(e);if(c)try{let r,i=cc.Class.attr(c.constructor,t);if(i&&Array.isArray(o(i.default)))r=[];else{let e=cc.js._getClassById(n);if(e)try{r=new e}catch(n){return Editor.error(`Can not new property at ${t} for type ${cc.js.getClassName(e)}.\n${n.stack}`),void 0}}r&&(_Scene.Undo.recordObject(e),Editor.setDeepPropertyByPath(c,t,r,n),_Scene.Undo.commit(),cc.engine.repaintInEditMode())}catch(e){Editor.warn(`Failed to new property ${c.name} at ${t}, ${e.message}`)}},resetProperty:function(e,t,n){let o=cc.engine.getInstanceById(e);if(o){_Scene.Undo.recordObject(e);try{Editor.resetPropertyByPath(o,t,n)}catch(e){Editor.warn(`Failed to reset property ${o.name} at ${t}, ${e.message}`)}_Scene.Undo.commit(),cc.engine.repaintInEditMode()}},setProperty:function(e){let t=cc.engine.getInstanceById(e.id);if(!t)return!1;if(n.isRecordCurrentClip(t,e))return!1;try{let o=t;if(o instanceof cc.Component&&(o=t.node),_Scene.Undo.recordNode(o.uuid),Editor.setPropertyByPath(t,e),cc.engine.repaintInEditMode(),m(t)){let e=setInterval(()=>{m(t)||(clearInterval(e),n.recordNodeChanged([o],t))},100)}else n.recordNodeChanged([o],t);return!0}catch(n){return n instanceof Editor.setPropertyByPath.ProhibitedException||Editor.warn(`Failed to set property ${t.name} to ${e.value} at ${e.path}, ${n.stack}`),!1}},copyNodeDataToNodes:function(e,t){if(e&&t&&t.length>0){let n=(t=t.map(e=>cc.engine.getInstanceById(e)))[0],o=cc.mat4();n.getWorldRT(o),i.invert(o,o);let d=n.getWorldRotation(cc.quat());r.invert(d,d);let a=e.getWorldPosition(cc.v3()),s=e.getWorldRotation(cc.quat()),l=cc.mat4();if(e.getWorldRT(l),_Scene.Undo.recordNode(n.uuid),n.setWorldPosition(a),n.setWorldRotation(s),t.length>1)for(let e=1;e<t.length;e++){let n=t[e],i=n.getWorldPosition(cc.v3()),a=n.getWorldRotation(cc.quat());_Scene.Undo.recordNode(n.uuid),c.transformMat4(i,i,o),r.mul(a,d,a),c.transformMat4(i,i,l),n.setWorldPosition(i),r.mul(a,s,a),n.setWorldRotation(a)}_Scene.Undo.commit()}}};