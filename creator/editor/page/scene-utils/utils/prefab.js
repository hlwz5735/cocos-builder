"use strict";const e=require("./node");CC_EDITOR&&Editor.require("unpack://engine-dev/cocos2d/core/utils/prefab-helper");var n=require("../../../share/engine-extends/object-walker"),r=["parent","rotation","rotationX","rotationY","angle"],t=r.concat("name","active","position","x","y","zIndex"),o=["node","_objFlags"],a=["quat"],i=[];(function(){for(var e=cc.Node,n=e.__props__,o=0;o<n.length;o++){var c=n[o],f=cc.Class.attr(e,c);!1===f.serializable&&!f.hasGetter&&!f.hasSetter||f.readonly||"_"===c[0]||f.hasGetter!==f.hasSetter||(cc.js.array.contains(r,c)||a.push(c),cc.js.array.contains(t,c)||i.push(c))}})();var c={};function f(e,n){if(!n(e))for(var r=e._children,t=r.length-1;t>=0;--t)f(r[t],n)}function s(e,n,r,t){var o=e._prefab=new cc._PrefabInfo;o.asset=n,o.root=r,o.fileId=t||e.uuid}function d(e,n,r){for(var t,o,c,f=r?i:a,s=0;s<f.length;s++){var d=f[s];n[d]=e[d]}for(t=0;t<n._components.length;++t)o=n._components[t],(c=e.getComponent(o.constructor))&&o.constructor===c.constructor||o.destroy();cc.Object._deferredDestroy();var p=[];for(t=0;t<e._components.length;++t)c=e._components[t],(o=n.getComponent(c.constructor))&&o.constructor===c.constructor||(o=n.addComponent(c.constructor)),p.push(o),o instanceof cc.RenderComponent?l(c,o):u(c,o);e._components.length=0,e._components.push.apply(e._components,p)}function u(e,n){for(var r=n.constructor.__values__,t=0;t<r.length;t++){var a=r[t];if(!cc.js.array.contains(o,a)){var i=e[a];n[a]=i}}}function l(e,n){let r=n.constructor,t=r.__props__;for(let a in t){let i=t[a],c=cc.Class.attr(r,i);!1===c.serializable&&!c.hasGetter&&!c.hasSetter||c.readonly||"_"===i[0]||c.hasGetter!==c.hasSetter||(cc.js.array.contains(o,i)||(n[i]=e[i]))}}function p(e,n){if(e._prefab&&e._prefab.fileId===n)return e;for(var r=e._children,t=0,o=r.length;t<o;t++)if(e=p(r[t],n))return e;return null}function _(e,r){n.walkProperties(r,function(n,r,t,o){if(t&&"object"==typeof t&&(cc.Node.isNode(t)||t instanceof cc.Component)){if(n instanceof cc.Component){if("node"===r)return}else{if(n instanceof cc._BaseNode||n instanceof cc._PrefabInfo||n instanceof cc.Asset)return;for(var a=null,i=o.length-1;i>=0;i--){var c=o[i];if(c instanceof cc.Component||cc.Node.isNode(c)||c instanceof cc.Asset||c instanceof cc._PrefabInfo){a=c;break}}if(!(a instanceof cc.Component)){if(a)return;Editor.error("Unknown parsing object")}}(function(e,n,r,t){var o;if(!(o=r instanceof cc.Component?r.node:r)._prefab)return cc.error("Node in prefab should have PrefabInfo");var a=p(t,o._prefab.fileId);a&&r instanceof cc.Component&&(a=a.getComponent(r.constructor)),e[n]=a})(n,r,t,e)}},{ignoreParent:!0})}function b(n,r,t,o,a){var i=t.node,c=i&&i._prefab&&i._prefab.root,f=n&&n._prefab&&n._prefab.root;if(c!==f){var s;if(c&&c._prefab.sync)s="MESSAGE.prefab.synced_disallow_ref_to_external";else if(f&&f._prefab.sync)n!==f?s="MESSAGE.prefab.disallow_ref_to_chlid_of_synced":r&&(s="MESSAGE.prefab.disallow_ref_to_comp_of_synced");if(s)return function(n,r,t,o,a){var i=Editor.T(n),c=Editor.T("MESSAGE.prefab.invalid_ref_detail",{component:cc.js.getClassName(t),property:o,node:e.getNodePath(r)});a?Editor.Dialog.messageBox({type:"warning",buttons:[Editor.T("MESSAGE.sure")],message:i,detail:c,noLink:!0}):Editor.error(Editor.T("MESSAGE.prefab.message_and_detail",{message:i,detail:c}))}(s,i,t,o,a),!1}return!0}c.getDumpableNode=function(e,n){return f(e=cc.instantiate(e),function(r){(function(e,n){function r(e,r){for(var t=(r=r||e.constructor).__values__,o=0;o<t.length;o++){var a=t[o],i=e[a];if(i&&"object"==typeof i)if(Array.isArray(i))for(var c=0;c<i.length;c++)cc.isValid(i)&&n(i,""+c,i[c]);else cc.isValid(i)&&n(e,a,i)}}for(var t=0;t<e._components.length;++t)r(e._components[t])})(r,function(r,t,o){var a,i=!1;o instanceof cc.Component.EventHandler&&(o=o.target),o instanceof cc.Component&&(o=o.node),o instanceof cc._BaseNode&&(o.isChildOf(e)||(i=!0,a=o.name)),i&&(r[t]=null,CC_TEST||n||Editor.error('Reference "%s" of "%s" to external scene object "%s" can not be saved in prefab asset.',t,r.name||e.name,a))}),r._id="";for(var t=0;t<r._components.length;++t){r._components[t]._id=""}}),e._prefab.sync=!1,e},c.createPrefabFrom=function(e,n){var r=new cc.Prefab;f(e,function(t){let o=void 0;n&&(o=n(t)),s(t,r,e,o)});var t=c.getDumpableNode(e);return r.data=t,r},c.createAppliedPrefab=function(e){var n=c.getDumpableNode(e._prefab.root),r=new cc.Prefab;return r.data=n,r},c.linkPrefab=function(e,n,r){if(!e._uuid)return cc.error('Can not get uuid from asset "%s"',e.name),void 0;f(r||n,function(r){var t=r._prefab;t?(t.asset=e,t.root=n):s(r,e,n)}),r&&n!==r&&(r._prefab.sync=!1),e.data&&(n._prefab.fileId=e.data._prefab.fileId)},c.initClonedChildOfPrefab=function(e){f(e,function(e){e._prefab.fileId=e.uuid})},c.unlinkPrefab=function(e){f(e,function(e){e._prefab=null})},c._doRevertPrefab=function(e,n){var r=n.data,t=Object.create(null),o=Object.create(null);if(e._prefab.fileId!==r._prefab.fileId)return Editor.error("Can not revert prefab because the scene node's uuid mismatched with the prefab's track id, your should instantiate a new node from prefab.");function a(e,n){throw new Error(`Can not revert prefab, the file id of ${e} is duplicated with ${n}, please recreate the prefab again by click [${Editor.T("MAIN_MENU.node.title")} - ${Editor.T("MAIN_MENU.node.break_prefab_instance")}] and [${Editor.T("MAIN_MENU.node.title")} - ${Editor.T("MAIN_MENU.node.link_prefab")}] in the menu.`)}f(r,function(r){var i=r._prefab.fileId;if(!i)throw new Error('Can not revert prefab, the file id of "'+r.name+'" is missing, please save the prefab to a new asset by dragging and drop the node from Node Tree into Assets.');i in o&&a(`"${r.name}" in prefab asset`,`"${o[i].name}"`),o[i]=r;var c=p(e,i);if(c||(d(r,c=new cc.Node,!1),s(c,n,e,i)),i in t&&a(`"${c.name}" in scene`,`"${t[i].name}"`),t[i]=c,r._parent){var f=r._parent._prefab.fileId,u=t[f];console.assert(u,"parent should exist since we create them from ascendent to descendant"),c.parent=u}}),f(e,function(n){if(n._prefab){var r=n._prefab.fileId,t=o[r];if(t)return d(t,n,n===e),void 0}return n.destroy(),!0}),cc.Object._deferredDestroy(),f(r,function(e){var n=e._children;if(n)for(var r=0;r<n.length;r++){var o=n[r]._prefab.fileId;t[o].setSiblingIndex(r)}})},c.revertPrefab=function(e,n){if(CC_EDITOR&&cc.engine.isPlaying)return cc.warn("Disallow to revert prefab when the engine is playing.");if(e._prefab){var r=e._prefab.asset._uuid;cc.AssetLibrary.loadAsset(r,function(r,t){r||(_(e,t.data),c._doRevertPrefab(e,t),n&&n())})}},c._setPrefabSync=function(e,n){e._prefab.sync=n,e._prefab._synced=n},c.setPrefabSync=function(n,r,t){if(n._prefab.sync!==r&&r&&!CC_TEST){var o,a={node:e.getNodePath(n),asset:Editor.assetdb.remote.uuidToUrl(n._prefab.asset._uuid)};if(t){if(0===(o=Editor.Dialog.messageBox({type:"question",buttons:[Editor.T("MESSAGE.cancel"),Editor.T("MESSAGE.revert")],message:Editor.T("MESSAGE.prefab.revert_missing_prefab"),detail:Editor.T("MESSAGE.prefab.revert_missing_prefab_detail",a),defaultId:1,cancelId:0,noLink:!0})))return!1;_Scene.revertPrefab(n.uuid)}else{let e=n._prefab.asset.readonly,r=[Editor.T("MESSAGE.apply"),Editor.T("MESSAGE.cancel"),Editor.T("INSPECTOR.node.prefab_btn_revert")];if(e&&(r=[Editor.T("INSPECTOR.node.prefab_btn_revert"),Editor.T("MESSAGE.cancel")]),1===(o=Editor.Dialog.messageBox({type:"question",buttons:r,message:Editor.T("MESSAGE.prefab.apply_new_synced_prefab_message"),detail:Editor.T("MESSAGE.prefab.apply_synced_prefab_detail",a),defaultId:0,cancelId:1,noLink:!0})))return!1;e||0!==o?_Scene.revertPrefab(n.uuid):_Scene.applyPrefab(n.uuid)}}return this._setPrefabSync(n,r),!0},c.syncPrefab=function(e){f(cc.director.getScene(),function(n){if(!n)return!0;var r=n._prefab,t=!1;return r&&(r.sync&&r.asset&&r.asset._uuid===e&&c.revertPrefab(n),t=!0),t})},c.validateSceneReference=function(e,n,r){var t,o;if(e instanceof cc.Component)o=e,t=e.node;else{if(!cc.Node.isNode(e))return!0;t=e}return b(t,o,n,r,!0)},c.validateAllSceneReferences=function(e){n.walkProperties(e,function(e,r,t,o){var a,i;if(t instanceof cc.Component?(i=t,a=t.node):cc.Node.isNode(t)&&(a=t),a){var c;if(e instanceof cc.Component)c=e;else{if(e instanceof cc.Node)return;c=null;for(var f=o.length-1;f>=0;f--){var s=o[f];if(s instanceof cc.Component){c=s;break}if(s instanceof cc.Node)break}if(!c)return}b(a,i,c,c===e?r:n.getNextProperty(o,e,c),!1)}})},c.confirmPrefabSynced=function(n){if(n&&_Scene.Undo.syncedPrefabDirty(n)){if(0===Editor.Dialog.messageBox({type:"question",buttons:[Editor.T("MESSAGE.apply"),Editor.T("INSPECTOR.node.prefab_btn_revert")],message:Editor.T("MESSAGE.prefab.apply_synced_prefab_message"),detail:Editor.T("MESSAGE.prefab.apply_synced_prefab_detail",{node:e.getNodePath(n),asset:Editor.assetdb.remote.uuidToUrl(n._prefab.asset._uuid)}),defaultId:0,cancelId:1,noLink:!0}))return _Scene.applyPrefab(n.uuid),!0;_Scene.revertPrefab(n.uuid)}return!1},c.confirmEditingPrefabSynced=function(){var e=Editor.Selection.curActivate("node"),n=e&&cc.engine.getInstanceById(e);n&&n._prefab&&n._prefab.root._prefab.sync&&c.confirmPrefabSynced(n._prefab.root)};var E=-1,v=null;c.confirmPrefabSyncedLater=function(e){if(v){E&&(clearTimeout(E),E=-1);var n=v;v=null;var r=Editor.Selection.curActivate("node"),t=r&&cc.engine.getInstanceById(r);if(t)if((t._prefab&&t._prefab.root)===n)return;this.confirmPrefabSynced(n)}else if(!e)return console.error("Root is invalid");e&&(v=e,E=setTimeout(function(){c.confirmPrefabSyncedLater()},100))},c.NodeRevertableProps_Root=i,c.MISSING_PREFAB_SUFFIX=" (Missing Prefab)",module.exports=c;