"use strict";const e=cc.vmath.quat;let t={},n=cc.vmath.mat4.create(),o=cc.v3();function c(e){var t,n=e._components.length;for(t=0;t<n;++t){var o=e._components[t];o._enabled&&cc.director._compScheduler.disableComp(o)}for(t=0,n=e._children.length;t<n;++t){var r=e._children[t];r._active&&c(r)}}t.getObbFromRect=function(e,t,n,o,c,r){let i=t.x,a=t.y,s=t.width,l=t.height,u=e.m00*i+e.m04*a+e.m12,d=e.m01*i+e.m05*a+e.m13,f=e.m00*s,g=e.m01*s,m=e.m04*l,h=e.m05*l;return n=n||cc.v3(),o=o||cc.v3(),c=c||cc.v3(),r=r||cc.v3(),o.x=u,o.y=d,c.x=f+u,c.y=g+d,n.x=m+u,n.y=h+d,r.x=f+m+u,r.y=g+h+d,[n,o,c,r]},t.getWorldBounds=function(e,t,o){t=t||e.getContentSize();let c=e.getAnchorPoint(),r=t.width,i=t.height,a=new cc.Rect(-c.x*r,-c.y*i,r,i);return e.getWorldMatrix(n),a.transformMat4(a,n),o?(o.x=a.x,o.y=a.y,o.width=a.width,o.height=a.height,o):a},t.getWorldOrientedBounds=function(e,o,c,r,i,a){let s=e.getComponent(cc.MeshRenderer);if(e.getWorldMatrix(n),s)return t.getObbFromMeshRenderer(s,n);{o=o||e.getContentSize();let s=e.getAnchorPoint(),l=o.width,u=o.height,d=new cc.Rect(-s.x*l,-s.y*u,l,u),f=t.getObbFromRect(n,d,c,r,i,a),g=t.getWorldPosition3D(e);return f.forEach(e=>{e.z=g.z}),f}},t.getObbFromMeshRenderer=function(e,t){const n=Editor.require("unpack://engine-dev/cocos2d/core/geom-utils/aabb");let o=n.create(0,0,0,0,0,0);if(e&&e._boundingBox){n.clone(e._boundingBox).transform(t,null,null,null,o)}let c=cc.v3(),r=cc.v3();o.getBoundary(c,r);let i=[];return i.push(c),i.push(cc.v3(r.x,c.y,c.z)),i.push(cc.v3(r.x,r.y,c.z)),i.push(cc.v3(c.x,r.y,c.z)),i.push(r),i.push(cc.v3(c.x,r.y,r.z)),i.push(cc.v3(c.x,c.y,r.z)),i.push(cc.v3(r.x,c.y,r.z)),i},t.getScenePosition=function(e){let n=cc.director.getScene();return n?n.convertToNodeSpaceAR(t.getWorldPosition(e)):(cc.error("Can not access scenePosition if no running scene"),cc.Vec2.ZERO)},t.setScenePosition=function(e,n){let o=cc.director.getScene();if(!o)return cc.error("Can not access scenePosition if no running scene"),void 0;t.setWorldPosition(e,cc.v2(o.convertToWorldSpaceAR(n)))},t.getSceneRotation=function(e){let n=cc.director.getScene();return n?t.getWorldRotation(e)-n.angle:(cc.error("Can not access sceneRotation if no running scene"),0)},t.setSceneRotation=function(e,n){let o=cc.director.getScene();if(!o)return cc.error("Can not access sceneRotation if no running scene"),void 0;t.setWorldRotation(o.angle+n)},t.getWorldPosition=function(e){let t=e.convertToWorldSpaceAR(cc.v2(0,0));return cc.v2(t.x,t.y)},t.setWorldPosition=function(e,t){if(t instanceof cc.Vec2)if(e.parent){let n=e.parent.convertToNodeSpaceAR(t);e.x=n.x,e.y=n.y}else e.x=t.x,e.y=t.y;else cc.error("The new worldPosition must be cc.Vec2")},t.getWorldRotation=function(e){let n=e.parent;return n?n instanceof cc.Scene?e.angle+n.angle:e.angle+t.getWorldRotation(n):e.angle},t.setWorldRotation=function(e,n){if(isNaN(n))cc.error("The new worldRotation must not be NaN");else{let o=e.parent;o?o instanceof cc.Scene?e.angle=n-o.angle:e.angle=n-t.getWorldRotation(o):e.angle=n}},t.getWorldScale=function(e){e.getWorldMatrix(n);let t=n.m00,o=n.m01,c=n.m04,r=n.m05,i=new cc.Vec2;return i.x=Math.sqrt(t*t+o*o),i.y=Math.sqrt(c*c+r*r),0!==t&&t===-r&&0===o&&0===c&&(t<0?i.x=-i.x:i.y=-i.y),i},t._hasFlagInComponents=function(e,t){let n=e._components;for(let e=0,o=n.length;e<o;++e){if(n[e]._objFlags&t)return!0}return!1},t._destroyForUndo=function(e,t){cc.Node.isNode(e)&&(e._activeInHierarchy&&c(e),function(e){let t=e._components.length;for(let n=0;n<t;++n){let t=e._components[n];cc.director._nodeActivator.destroyComp(t)}for(let t=0,n=e.childrenCount;t<n;++t){let n=e._children[t];n._active&&c(n)}}(e)),t(),e.destroy()},t.getNodePath=function(e){let t="";for(;e&&!(e instanceof cc.Scene);)t=t?e.name+"/"+t:e.name,e=e._parent;return t};var r=new Array(32);t.getChildUuids=function(e,t){var n=[];t&&n.push(e.uuid);var o=0;for(r[0]=e;o>=0;){var c=r[o];if(r[o]=null,--o,c){var i=c._children;if(i)for(var a=0,s=i.length;a<s;++a){var l=i[a];r[++o]=l,n.push(l.uuid)}}}return n},t.createNodeFromAsset=function(e,t){const n=require("../lib/sandbox");cc.AssetLibrary.queryAssetInfo(e,(o,c,r,i)=>{if(o)return t(o);if(r)return t(new Error("Can not create node from raw asset: "+cc.js.getClassName(i))),void 0;if(cc.js.isChildClassOf(i,cc._Script)){let o,r=Editor.Utils.UuidUtils.compressUuid(e),i=cc.js._getClassById(r);if(cc.js.isChildClassOf(i,cc.Component))(o=new cc.Node(cc.js.getClassName(i))).addComponent(i),t(null,o);else{let e=(!CC_TEST&&require("fire-url")).basename(c);"compiling"===Editor.remote.Compiler.state||n.reloading?t(new Error(`Can not load "${e}", please wait for the scene to reload.`)):t(new Error(`Can not find a component in the script "${e}".`))}}else cc.AssetLibrary.loadAsset(e,(e,n)=>{if(e)return t(e);if(n.createNode){if(n instanceof cc.Prefab){if(Editor.globalProfile.data["auto-sync-prefab"]){require("./prefab")._setPrefabSync(n.data,!0)}}n.createNode(t)}else t(new Error("Can not create node from "+cc.js.getClassName(i)))})})},t.createNodeFromClass=function(e,t){let n=new cc.Node,o=null;if(e){let t=cc.js._getClassById(e);if(t){var c=n.addComponent(t);c&&cc.director._nodeActivator.resetComp(c)}else o=new Error(`Unknown node to create: ${e}`)}t&&t(o,n)},t.makeVec3InPrecision=function(e,t){return e.x=Editor.Math.toPrecision(e.x,t),e.y=Editor.Math.toPrecision(e.y,t),e.z=Editor.Math.toPrecision(e.z,t),e},t.getWorldPosition3D=function(e){let t=cc.mat4(),n=cc.v3(0,0,0);return e.getWorldMatrix(t),cc.vmath.vec3.transformMat4(n,n,t),n},t.setWorldPosition3D=function(e,n,o=3){if(null==e)return;let c=cc.v3();if(n instanceof cc.Vec3){if(e.parent){let t=cc.mat4(),o=cc.mat4();e.parent.getWorldMatrix(t),cc.vmath.mat4.invert(o,t),cc.vmath.vec3.transformMat4(c,n,o)}else c=n;c=t.makeVec3InPrecision(c,o),e.setPosition(c.x,c.y,c.z)}else cc.error("The new worldPosition must be cc.Vec3")},t.getWorldRotation3D=function(n){let o=n.parent,c=cc.quat(0,0,0,1),r=cc.quat(0,0,0,1);return n.getRotation(r),o?(e.mul(c,t.getWorldRotation3D(o),r),c):r},t.setWorldRotation3D=function(n,o,c=3){if(o instanceof cc.Quat){let r=n.parent,i=cc.quat(0,0,0,1),a=cc.quat(0,0,0,1);r?(r.getRotation(i),e.conjugate(i,i),e.mul(a,i,o)):a=o;let s=cc.v3();e.toEuler(s,a),s=t.makeVec3InPrecision(s,c),t.setEulerAngles(n,s)}else cc.error("The new worldRotation must be Quat")},t.getEulerAngles=function(e){return e.eulerAngles},t.setEulerAngles=function(e,t){e.eulerAngles=t},t.getWorldScale3D=function(e){return e.getWorldScale(o)},module.exports=t;