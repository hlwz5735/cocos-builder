var e=require("lodash"),r=require("fire-url"),s=require("../../share/engine-extends/object-walker"),i=Editor.require("app://editor/page/scene-utils/utils/node"),t=cc.js._getClassById,n=require("./missing-reporter");function o(s,t,o,a,c,d){d=d||s._$erialized&&s._$erialized.__type__,function(e,s,t,o){var a=n.getObjectType(t),c=o&&r.basename(o);if(t instanceof cc.SceneAsset||t instanceof cc.Prefab){var d,l,p;e instanceof cc.Component?p=(l=e).node:cc.Node.isNode(e)&&(p=e);var u=c?` in ${a} "${c}"`:"",f=s,h=!1;if(l){var g=cc.js.getClassName(l);l instanceof cc._MissingScript&&(h=!0,f=g=l._$erialized.__type__),d=`Class "${s}" used by component "${g}"${u} is missing or invalid.`}else{if(!p)return;h=!0,d=`Script attached to "${p.name}"${u} is missing or invalid.`}d+=n.INFO_DETAILED,d+=`Node path: "${i.getNodePath(p)}"\n`,o&&(d+=`Asset url: "${o}"\n`),h&&Editor.Utils.UuidUtils.isUuid(f)&&(d+=`Script UUID: "${Editor.Utils.UuidUtils.decompressUuid(f)}"\n`,d+=`Class ID: "${f}"\n`),d.slice(0,-1),Editor.warn(d)}}(t instanceof cc.Component||cc.Node.isNode(t)?t:e.findLast(o,e=>e instanceof cc.Component||cc.Node.isNode(e)),d,a,c)}function a(e){n.call(this,e)}cc.js.extend(a,n),a.prototype.report=function(){s.walk(this.root,(e,r,s,i)=>{this.missingObjects.has(s)&&o(s,e,i,this.root)})},a.prototype.reportByOwner=function(){var e;this.root instanceof cc.Asset&&(e=Editor.assetdb.remote.uuidToUrl(this.root._uuid)),s.walkProperties(this.root,(r,s,i,t)=>{var n=this.missingOwners.get(r);if(n&&s in n){var a=n[s];o(i,r,t,this.root,e,a)}},{dontSkipNull:!0})};var c={reporter:new a,classFinder:function(e,r,s,i){var n=t(e);return n||(e&&(c.hasMissingClass=!0,c.reporter.stashByOwner(s,i,e)),null)},hasMissingClass:!1,reportMissingClass:function(e){c.reporter.root=e,c.reporter.reportByOwner(),c.reporter.reset()}};c.classFinder.onDereferenced=function(e,r,s,i){var t=c.reporter.removeStashedByOwner(e,r);t&&c.reporter.stashByOwner(s,i,t)},module.exports={MissingClass:c,MissingClassReporter:a};