"use strict";const e=require("fire-path"),r=(require("fire-url"),require("async")),i=(require("fire-fs"),require("node-uuid")),s=(require("./source-maps"),require("../global-variables-protecter"));let o,t,a,n=require,l=!1,c=require("../../project-scripts"),d=c.loadScript;c.loadScript=function(r,i){var s=g._globalsVerifier_loadPluginScript,o=e.relative(Editor.Project.path,r);"."===o[0]&&(o=r),s.info="loading "+o,s.record(),d.call(c,r,()=>{s.restore(),i()})};let u=c.loadCommon;c.loadCommon=function(e){var r=g._globalsVerifier_loadScript;r.info="loading common project scripts",r.record(),u.call(c,()=>{r.restore(),e()})};let g={reset(){cc.Object._deferredDestroy(),cc._componentMenuItems=a.slice(),cc.js._registeredClassIds=o,cc.js._registeredClassNames=t,this._globalsVerifier_editing.isRecorded()&&this._globalsVerifier_editing.restore(),this._globalsProtecter.isRecorded()&&this._globalsProtecter.restore(),cc._RF.reset(),Editor.Utils.UuidCache.clear(),cc.director.reset(),cc.loader.releaseAll()},reload(e,i){this.compiled=e,this.reloading=!0;var s=_Scene.getEditingWorkspace();_Scene.reset();var o={scene:cc.director.getScene(),sceneName:cc.director.getScene().name,undo:_Scene.Undo.dump(),stashedDatas:this._liveReloadableDatas},t=Editor.serialize(o,{stringify:!1,discardInvalid:!1,reserveContentsForSyncablePrefab:!0});(function(){var e=Editor.require("unpack://engine-dev/cocos2d/core/load-pipeline/uuid-loader").isSceneObj(t);console.assert(e,"jsons should be scene object to support missing script")})();var a=cc.deserialize.reportMissingClass;r.waterfall([e=>{Editor.Profile.load("profile://global/settings.json",(r,i)=>{e(null,i)})},(e,r)=>{e.data["auto-refresh"]?_Scene.stashScene(()=>{Editor.Ipc.sendToMain("app:reload-on-device"),r()}):r()},e=>{g.reset(),e()},g.loadScripts,e=>{this._globalsVerifier_loadScene.record(),cc.deserialize.reportMissingClass=function(){},cc.AssetLibrary.loadJson(t,e)},(e,r)=>{cc.deserialize.reportMissingClass=a,this._globalsVerifier_loadScene.restore(),e.scene.name=e.sceneName,e.scene._prefabSyncedInLiveReload=!0,this._globalsVerifier_unloadScene.record(),this._globalsVerifier_runScene.record(),cc.director.runSceneImmediate(e.scene,()=>{this._globalsVerifier_unloadScene.restore()}),this._globalsVerifier_runScene.restore(),this._globalsVerifier_editing.record(),e.scene._prefabSyncedInLiveReload=!1,_Scene.Undo.restore(e.undo),this._liveReloadableDatas=e.stashedDatas,_Scene.loadWorkspace(s),r(null)}],(e,r)=>{cc.deserialize.reportMissingClass=a,this.reloading=!1,i(e,r)})},loadScripts(e){l||(l=!0,g._globalsProtecter.record(),o=cc.js._registeredClassIds,t=cc.js._registeredClassNames,a=cc._componentMenuItems.slice()),c.load(r=>{let i=cc.js,s=require("lodash"),o=["renderers","mesh","ui","collider","physics","others","scripts"];cc._componentMenuItems=s.sortBy(cc._componentMenuItems,function(e){return s.findIndex(o,function(r){return e.menuPath.includes("."+r+"/")})});for(var t=[],a=0;a<cc._componentMenuItems.length;++a){var n=cc._componentMenuItems[a],l=n.menuPath;t.push({path:Editor.i18n.formatPath(l),panel:"scene",message:"scene:add-component",params:[null,i._getClassId(n.component)]})}Editor.Menu.register("add-component",t,!0),Editor.MainMenu.update(Editor.T("MAIN_MENU.component.title"),t),e(r)})},_liveReloadableDatas:Object.create(null),registerReloadableData(e){var r=i.v4();return this._liveReloadableDatas[r]=e,r},popReloadableData(e){var r=this._liveReloadableDatas[e];return delete this._liveReloadableDatas[e],r},restoreElectronRequire(){require=n},getElectronRequire:()=>n,compiled:!1,reloading:!1,_globalsProtecter:new s,_globalsVerifier_loadPluginScript:new s({ignoreNames:["require"],callbacks:{modified:Editor.log,deleted:Editor.warn},dontRestore:{introduced:!0}}),_globalsVerifier_loadScript:new s({ignoreNames:["require"],callbacks:{modified:Editor.warn,deleted:Editor.warn},dontRestore:{introduced:!0}}),_globalsVerifier_editing:new s({info:"editing",callbacks:Editor.log}),_globalsVerifier_loadScene:new s({info:"deserializing scene by using new scripts",callbacks:Editor.warn}),_globalsVerifier_unloadScene:new s({info:"unloading the last scene",callbacks:Editor.warn}),_globalsVerifier_runScene:new s({info:"launching scene by using new scripts",callbacks:Editor.warn})};module.exports=g;