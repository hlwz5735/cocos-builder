var t=cc.Class.Attr.DELIMETER,e="A$$ETprops"+t+"A$$ETprops";function r(t){this.owner=t,this.watchingInfos=Object.create(null)}var s=Object.create(null);function a(t){return t instanceof cc.Asset&&t._uuid?t._uuid:"string"==typeof t&&t?Editor.Utils.UuidCache.urlToUuid(t):""}function n(t,e){var r=function(t,e){for(;t;){var r=Object.getOwnPropertyDescriptor(t,e);if(r)return{owner:t,pd:r};t=Object.getPrototypeOf(t)}return null}(t.prototype,e);if(!r)return console.warn("Failed to get property descriptor of %s.%s",cc.js.getClassName(t),e),void 0;var a=r.pd;if(!1===a.configurable)return console.warn("Failed to register notifier for %s.%s",cc.js.getClassName(t),e),void 0;if("value"in a)return console.warn("Cannot watch instance variable of %s.%s",cc.js.getClassName(t),e),void 0;var n=a.set;a.set=function(t,r){if(n.call(this,t,r),this._watcherHandle&&this._watcherHandle!==s){let t=this[e];this._watcherHandle.changeWatchAsset(e,t)}},Object.defineProperty(r.owner,e,a)}function i(t,e,r){var s=cc.js.getPropertyDescriptor(t,e);if(s&&s.set){s.set.call(t,r,!0)}}r.initComponent=function(t){t._watcherHandle=null},r.initHandle=function(a){var i=cc.Class.Attr.getClassAttrs(a.constructor)[e];void 0===i&&(i=function(e){for(var r=null,s=e.constructor,a=cc.Class.Attr.getClassAttrs(s),i=0,c=s.__props__;i<c.length;i++){var o=c[i],l=o+t;if(a[l+"hasSetter"]&&a[l+"hasGetter"]){var u=e[o];(u instanceof cc.Asset||cc.js.isChildClassOf(a[l+"ctor"],cc.RawAsset)||null==u)&&(n(s,o),r?r.push(o):r=[o])}}return r}(a),cc.Class.Attr.setClassAttr(a.constructor,"A$$ETprops","A$$ETprops",i)),a._watcherHandle=i?new r(a):s},r.start=function(t){t._watcherHandle||r.initHandle(t),t._watcherHandle!==s&&t._watcherHandle.start()},r.stop=function(t){t._watcherHandle&&t._watcherHandle!==s&&t._watcherHandle.stop()},r.prototype.start=function(){for(var t=this.owner,r=cc.Class.Attr.getClassAttrs(t.constructor)[e],s=0;s<r.length;s++){var n=r[s],i=t[n];if(Array.isArray(i)){let t=this.watchingInfos[n]=[];this._registerToArray(n,i,t)}else{var c=a(i);c&&this._register(n,c)}}},r.prototype.stop=function(){for(var t in this.watchingInfos){var e=this.watchingInfos[t];e&&cc.AssetLibrary.assetListener.remove(e.uuid,e.callback)}this.watchingInfos=Object.create(null)},r.prototype._register=function(t,e){var r=i.bind(null,this.owner,t);cc.AssetLibrary.assetListener.add(e,r),this.watchingInfos[t]={uuid:e,callback:r}},r.prototype._registerToArray=function(t,e,r){var s=function(t,e,r,s){let n=a(s);for(let t=0;t<r.length;t++)a(r[t])===n&&(r[t]=s);i(t,e,r)}.bind(null,this.owner,t,e);for(let t=0;t<e.length;t++){let n=a(e[t]);n&&(cc.AssetLibrary.assetListener.add(n,s),r.push({uuid:n,callback:s}))}},r.prototype.changeWatchAsset=function(t,e){var r=this.watchingInfos[t];if(Array.isArray(r)){for(let t=0;t<r.length;t++)cc.AssetLibrary.assetListener.remove(r[t].uuid,r[t].callback);if(Array.isArray(e))r.length=0,this._registerToArray(t,e,r);else{let r=a(e);r&&this._register(t,r)}}else if(Array.isArray(e))r&&cc.AssetLibrary.assetListener.remove(r.uuid,r.callback),this.watchingInfos[t]=r=[],this._registerToArray(t,e,r);else{let s=a(e);if(r){if(r.uuid===s)return;this.watchingInfos[t]=null,cc.AssetLibrary.assetListener.remove(r.uuid,r.callback)}s&&this._register(t,s)}},module.exports=r;