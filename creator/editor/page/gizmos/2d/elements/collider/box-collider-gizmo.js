"use strict";const t=Editor.require("scene://utils/node");let e=require("./collider-gizmo"),o=require("../tools"),i=o.rectTool.Type,r=cc.vmath,s=r.vec3,l=r.mat4,n=l.create();module.exports=class extends e{onCreateMoveCallbacks(){let t,e,o=this;function r(r,c,h,a){let y=o.getWorldDelta(c),x=cc.v2(y.x,y.y),d=o.node,g=o.target;(function(t,e,o,r,s){return t===i.Right||t===i.RightTop||t===i.RightBottom?(s&&(r.x/=1-e.x),o.x=r.x*e.x):(s&&(r.x/=e.x),o.x=r.x*(1-e.x)),t===i.LeftBottom||t===i.Bottom||t===i.RightBottom?(s&&(r.y/=1-e.y),o.y=r.y*e.y):(s&&(r.y/=e.y),o.y=r.y*(1-e.y)),o})(r,cc.v2(.5,.5),y,x,a),function(t,e,o,r){t===i.LeftBottom?o.x*=-1:t===i.LeftTop?(o.x*=-1,o.y*=-1):t===i.RightTop?o.y*=-1:t===i.Left?(o.x*=-1,r||(e.y=o.y=0)):t===i.Right?r||(e.y=o.y=0):t===i.Top?(o.y*=-1,r||(e.x=o.x=0)):t===i.Bottom&&(r||(e.x=o.x=0))}(r,y,x,h),h&&(x.y=x.x*(e.height/e.width)),d&&(d.getWorldMatrix(n),l.invert(n,n),n.m12=n.m13=0,s.transformMat4(y,y,n));let f=cc.v3();d.getWorldScale(f),x.x=x.x/f.x,x.y=x.y/f.y;let u=cc.size(e.width+x.x,e.height+x.y);if(!a){let e=cc.quat();d.getRotation(e),s.transformQuat(y,y,e),u.width<0&&(y.x-=u.width/2),u.height<0&&(y.y-=u.height/2),y=t.add(y),g.offset=y}u.width<0&&(u.width=0),u.height<0&&(u.height=0),g.size=u}return{start:()=>{t=this.target.offset.clone(),e=this.target.size.clone()},update:(e,s,l,n)=>{let c=new cc.Vec2(e,s);if(n===i.Center)(function(e){let i=o.screenToNodeLocalDelta(e,o.node);i.addSelf(t),o.target.offset=i})(c.clone());else{let t=!!l&&l.shiftKey,e=!!l&&l.altKey;r(n,this.getLocalAxisAlignDelta(n,c,this.node),t,e)}},end:(t,e,r)=>{if(!t)return;let s=o.target;r===i.Center?this.adjustValue(s,["offset"]):this.adjustValue(s,["offset","size"])}}}onCreateRoot(){let t,e,r,s,l,n,c,h,a,y,x=this._root,d=x.sideGroup=x.group().style("pointer-events","none");x.dragArea=y=x.polygon("0,0,0,0,0,0").fill({color:"rgba(0,128,255,0.2)"}).stroke("none").style("pointer-events","fill"),this.registerMoveSvg(y,i.Center);let g=(t,e)=>o.lineTool(d,cc.v2(0,0),cc.v2(0,0),"#7fc97a",e,this.createMoveCallbacks(t)).style("cursor",e);e=g(i.Left,"col-resize"),r=g(i.Top,"row-resize"),s=g(i.Right,"col-resize"),l=g(i.Bottom,"row-resize"),(t=x.sidePointGroup=x.group()).hide();let f=(t,e,i)=>o.circleTool(e,5,{color:"#7fc97a"},null,this.createMoveCallbacks(t)).style("cursor",i);n=f(i.LeftBottom,t,"nwse-resize"),c=f(i.LeftTop,t,"nesw-resize"),h=f(i.RightTop,t,"nwse-resize"),a=f(i.RightBottom,t,"nesw-resize"),x.plot=(t=>{y.plot([[t[0].x,t[0].y],[t[1].x,t[1].y],[t[2].x,t[2].y],[t[3].x,t[3].y]]),e.plot(t[0].x,t[0].y,t[1].x,t[1].y),r.plot(t[1].x,t[1].y,t[2].x,t[2].y),s.plot(t[2].x,t[2].y,t[3].x,t[3].y),l.plot(t[3].x,t[3].y,t[0].x,t[0].y),this._targetEditing&&(n.center(t[0].x,t[0].y),c.center(t[1].x,t[1].y),h.center(t[2].x,t[2].y),a.center(t[3].x,t[3].y))})}onUpdate(){let e=this.target,o=e.size,i=e.offset,r=cc.rect(i.x-o.width/2,i.y-o.height/2,o.width,o.height);this.node.getWorldMatrix(n);let s=t.getObbFromRect(n,r);s[0]=this.worldToPixel(s[0]),s[1]=this.worldToPixel(s[1]),s[2]=this.worldToPixel(s[2]),s[3]=this.worldToPixel(s[3]),this._root.plot(s)}enterEditing(){let t=this._root;t.sideGroup.style("pointer-events","stroke"),t.dragArea.style("cursor","move"),t.sidePointGroup.show()}leaveEditing(){let t=this._root;t.sideGroup.style("pointer-events","none"),t.dragArea.style("cursor",null),t.sidePointGroup.hide()}};