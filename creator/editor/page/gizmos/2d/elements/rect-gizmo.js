"use strict";const t=Editor.require("scene://utils/node"),e=require("../../utils/external").EditorMath;let o=require("./tools"),i=o.rectTool.Type,r=Editor.GizmosUtils.snapPixelWihVec2,n=cc.vmath,h=n.vec3,l=n.mat4,s=cc.v2,c=n.mat4.create(),a=new s,d=new s,g=cc.v3();module.exports=class extends Editor.Gizmo{init(){this._processing=!1,this._rect=cc.rect(0,0,0,0),this._tool=null}layer(){return"foreground"}onCreateMoveCallbacks(){let o=[],r=[],n=[],x=[],y=[],u=this;function f(t,e,o,r){t===i.LeftBottom?o.x*=-1:t===i.LeftTop?(o.x*=-1,o.y*=-1):t===i.RightTop?o.y*=-1:t===i.Left?(o.x*=-1,r||(e.y=o.y=0)):t===i.Right?r||(e.y=o.y=0):t===i.Top?(o.y*=-1,r||(e.x=o.x=0)):t===i.Bottom&&(r||(e.x=o.x=0))}function m(t,e,o,r,n){return t===i.Right||t===i.RightTop||t===i.RightBottom?(n&&(r.x/=1-e.x),o.x=r.x*e.x):(n&&(r.x/=e.x),o.x=r.x*(1-e.x)),t===i.LeftBottom||t===i.Bottom||t===i.RightBottom?(n&&(r.y/=1-e.y),o.y=r.y*e.y):(n&&(r.y/=e.y),o.y=r.y*(1-e.y)),o}return{start:()=>{o.length=0,n.length=0,r.length=0,x.length=0,y.length=0,y.tempRect=function(t){return cc.rect(t[1].x,t[1].y,t[3].x-t[1].x,t[3].y-t[1].y)}(u.getBounds()),u._processing=!0;for(let e=0,i=u.target.length;e<i;++e){let i=u.target[e];o.push(t.getWorldPosition(i)),r.push(i.position),n.push(i.getContentSize()),x.push(i.getAnchorPoint()),y.push(t.getWorldBounds(i))}},update:(p,w,P,v)=>{let _=new cc.Vec2(p,w);if(v===i.Anchor)(function(e){let i=u.target[0],r=n[0];a.set(i._position);let s=u.getWorldDelta(e);t.makeVec3InPrecision(s,3);let g=o[0].add(s);t.setWorldPosition(i,g),i.getWorldMatrix(c),l.invert(c,c),c.m12=c.m13=0,h.transformMat4(s,s,c),d.x=s.x/r.width,d.y=s.y/r.height;let y=x[0];d.addSelf(y),i.setAnchorPoint(d)})(_.clone());else if(v===i.Center){let t=cc.quat();u.node.getWorldRotation(t);let e=cc.v3(p,w,0),i=cc.v2();h.transformQuat(g,cc.Vec3.RIGHT,t),i.x=e.dot(g),h.transformQuat(g,cc.Vec3.UP,t),i.y=e.dot(g),function(t){let e=u.target.length;for(let i=0;i<e;++i){let e=u.target[i],r=(o[i],n[i]),h=x[i],l=u.screenToNodeLocalDelta(t,e.parent),s=cc.v3();e.getScale(s),0!==r.width&&(a.x=h.x-l.x/r.width/s.x),0!==r.height&&(a.y=h.y-l.y/r.height/s.y),e.setAnchorPoint(a)}}(i)}else{let i=!!P&&P.shiftKey,a=!!P&&P.altKey;u.target.length>1?function(e,i,r,h){let l=y.tempRect;r&&(i.y=i.x*(l.height/l.width));let c=u.getWorldDelta(i),a=cc.v2(c.x,c.y);f(e,a,c,r),m(e,h?s(.5,.5):s(0,0),a,c,h);let d=l.clone();d.x=l.x-a.x,d.y=l.y-a.y,d.width=l.width+c.x,d.height=l.height+c.y,u._rect=d;for(let e=0,i=u.target.length;e<i;e++){let i=u.target[e],r=o[e],h=(r.x-l.x)/l.width,a=(r.y-l.y)/l.height;t.setWorldPosition(i,s(d.x+h*d.width,d.y+a*d.height));let g=y[e],x=g.width/l.width,f=g.height/l.height,m=n[e],p=m.width>0?1:-1,w=m.height>0?1:-1,P=c.clone();P.x=P.x*x*p,P.y=P.y*f*w;let v=cc.v3();i.getWorldScale(v),P.x=P.x/v.x,P.y=P.y/v.y,i.setContentSize(cc.size(m.width+P.x,m.height+P.y))}}(v,_.clone(),i,a):function(t,o,i,s){let a=n[0];i&&(o.y=o.x*(a.height/a.width));let d=u.getWorldDelta(o),x=cc.v2(d.x,d.y),y=r[0],p=u.target[0],w=p.getAnchorPoint();if(x.x=e.toPrecision(x.x,3),x.y=e.toPrecision(x.y,3),m(t,w,d,x,s),f(t,d,x,i),p.parent&&(p.parent.getWorldMatrix(c),l.invert(c,c),c.m12=c.m13=0,h.transformMat4(d,d,c)),!s){let t=cc.quat();p.getRotation(t),h.transformQuat(d,d,t),d.z=0,g.set(y),g.addSelf(d),p.setPosition(g)}let P=cc.v3();p.getWorldScale(P),x.x=x.x/P.x,x.y=x.y/P.y;let v=a.width+x.x,_=a.height+x.y;p.setContentSize(cc.size(v,_))}(v,this.getLocalAxisAlignDelta(v,_,u.node),i,a)}},end:(t,e,o)=>{if(t)if(o<i.Center)this.adjustValue(node,["anchorX","anchorY"]);else if(o===i.Anchor){let t=u.target[0];this.adjustValue(t,["x","y"]);let e=(0|Math.max(t.width,t.height)).toString().length;this.adjustValue(t,["anchorX","anchorY"],this.defaultMinDifference()+e)}else this.adjustValue(u.target,["x","y","width","height"]);u._processing=!1}}}onCreateRoot(){this._tool=o.rectTool(this._root,this.createMoveCallbacks())}formatBounds(t){return[this.worldToPixel(t[0]),this.worldToPixel(t[1]),this.worldToPixel(t[2]),this.worldToPixel(t[3])]}getBounds(e,o){let i,r=Number.MAX_VALUE,n=-Number.MAX_VALUE,h=Number.MAX_VALUE,l=-Number.MAX_VALUE;function s(t){t.x>n&&(n=t.x),t.x<r&&(r=t.x),t.y>l&&(l=t.y),t.y<h&&(h=t.y)}return this.target.forEach(e=>{let o=t.getWorldOrientedBounds(e);s(o[0]),s(o[1]),s(o[2]),s(o[3])}),e&&(i=r,r=n,n=i),o&&(i=h,h=l,l=i),[cc.v2(r,l),cc.v2(r,h),cc.v2(n,h),cc.v2(n,l)]}onKeyDown(t){if(!this.target)return;let e=Editor.KeyCode(t.which);if("left"!==e&&"right"!==e&&"up"!==e&&"down"!==e)return;let o=t.shiftKey?10:1,i=cc.v2();"left"===e?i.x=-1*o:"right"===e?i.x=o:"up"===e?i.y=o:"down"===e&&(i.y=-1*o),this.recordChanges(),this.topNodes.forEach(t=>{t.position=t.position.add(i)}),this._view.repaintHost()}onKeyUp(t){if(!this.target)return;let e=Editor.KeyCode(t.which);"left"!==e&&"right"!==e&&"up"!==e&&"down"!==e||this.commitChanges()}visible(){return!0}dirty(){return!0}onUpdate(){let e=[];if(1===this.target.length){let o=this.target[0];e=t.getWorldOrientedBounds(o),e=this.formatBounds(e);let i=t.getWorldPosition(o),n=t.getWorldPosition(o.parent);e.anchor=this.worldToPixel(i),e.origin=this.worldToPixel(n),e.localPosition=r(o.getPosition()),o.getContentSize?e.localSize=o.getContentSize():e.localSize=cc.size()}else{let t=!1,o=!1;this._processing&&(t=this._rect.width<0,o=this._rect.height<0),e=this.getBounds(t,o),e=this.formatBounds(e)}this._tool.setBounds(e)}};