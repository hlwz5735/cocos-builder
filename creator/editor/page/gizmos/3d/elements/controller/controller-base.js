"use strict";const e=cc.vmath.vec3,t=cc.vmath.vec2,i=require("../../../utils/external"),o=i.NodeUtils,s=i.EditorCamera,r=require("../utils/controller-utils"),n=require("../utils/controller-shape-collider"),{setNodeOpacity:a,create3DNode:h,setMeshColor:l,getModel:c,getMeshColor:d,getNodeOpacity:u}=require("../../../utils/engine");let p=require("../../../utils/transform-tool-data");const g=require("../../../utils");let v=cc.v3();module.exports=class{constructor(e){this._position=cc.v3(0,0,0),this._rotation=cc.quat(0,0,0,1),this._scale=cc.v3(1,1,1),this._updated=!1,this.shape=null,this._rootNode=e,this._baseDist=600,this._axisDataMap={},this._axisDir={},this._axisDir.x=cc.v3(1,0,0),this._axisDir.y=cc.v3(0,1,0),this._axisDir.z=cc.v3(0,0,1),this._twoPI=2*Math.PI,this._halfPI=Math.PI/2,this._degreeToRadianFactor=Math.PI/180}get is2D(){return p.is2D}get scale2D(){return p.scale2D}createShapeNode(e){this.shape=h(e),this.shape.parent=this._rootNode}registerSizeChangeEvents(){this.registerCameraMovedEvent(),p.on("dimension-changed",this.onDimensionChanged.bind(this)),p.on("scale2D-changed",this.onScale2DChanged.bind(this))}registerCameraMovedEvent(){s._camera.node.on("transform-changed",this.onEditorCameraMoved,this)}onEditorCameraMoved(){this.adjustControllerSize()}initAxis(e,t){let i={};i.topNode=e,i.rendererNodes=this.getRendererNodes(e);let o=[],s=[];i.rendererNodes.forEach(e=>{let t=d(e);o.push(new cc.Color(t.r,t.g,t.b)),s.push(u(e))}),i.oriColors=o,i.oriOpacitys=s,this._axisDataMap[t]=i,this.getRayDetectNodes(e).forEach(e=>{this.registerMouseEvents(e,t)}),this.onInitAxis&&this.onInitAxis(e,t)}setAxisColor(e,t,i=255){let o=this._axisDataMap[e].rendererNodes;null!=o&&o.forEach(e=>{l(e,t),a(e,i)})}resetAxisColor(){for(let e in this._axisDataMap)if(e){let t=this._axisDataMap[e],i=t.rendererNodes,o=t.oriColors,s=t.oriOpacitys;for(let e=0;e<i.length;e++){let t=i[e];l(t,o[e]),a(t,s[e])}}}registerMouseEvents(e,t){e.on("mouseDown",function(i){i.axisName=t,i.node=e,this._updated=!1,this.onMouseDown&&this.onMouseDown(i),i.stopPropagation()}.bind(this)),e.on("mouseMove",function(i){this._updated=!0,i.axisName=t,i.node=e,this.onMouseMove&&this.onMouseMove(i),i.stopPropagation(),g.repaintEngine()}.bind(this)),e.on("mouseUp",function(i){i.axisName=t,i.node=e,this.onMouseUp&&this.onMouseUp(i),i.stopPropagation(),this._updated=!1}.bind(this)),e.on("mouseLeave",function(e){this.onMouseLeave&&this.onMouseLeave(e),e.stopPropagation(),this._updated=!1}.bind(this)),e.on("hoverIn",function(i){i.axisName=t,i.node=e,this.onHoverIn&&this.onHoverIn(i),i.stopPropagation(),g.repaintEngine()}.bind(this)),e.on("hoverOut",function(i){i.axisName=t,i.node=e,this.onHoverOut&&this.onHoverOut(i),i.stopPropagation(),g.repaintEngine()}.bind(this))}get updated(){return this._updated}setPosition(e){e instanceof cc.Vec3?this._position=e:this._position=cc.v3(e.x,e.y,0),this.updateController()}getPosition(){return this._position}setRotation(e){this._rotation=e,this.updateController()}getScale(){return this._scale}setScale(e){this._scale=e,this.updateController()}updateController(){this.updateController3D()}updateController3D(){o.setWorldPosition3D(this.shape,this._position),o.setWorldRotation3D(this.shape,this._rotation),this.adjustControllerSize()}getCameraDistScalar(e){let t=s._camera.node;return r.getCameraDistanceFactor(e,t)/this._baseDist}getDistScalar(){let e=1;return e=this.is2D?1/this.scale2D:this.getCameraDistScalar(this._position)}adjustControllerSize(){let e=this.getDistScalar();this.shape.setScale(this._scale.mul(e))}needRender(e){let t=e.getComponent(n);return!t||!1!==t.isRender}getRendererNodes(e){let t=[];c(e)&&this.needRender(e)&&t.push(e);for(let i=0;i<e.childrenCount;i++){let o=e._children[i];t=t.concat(this.getRendererNodes(o))}return t}getRayDetectNodes(e){let t=[];c(e)&&t.push(e);for(let i=0;i<e.childrenCount;i++){let o=e._children[i];t=t.concat(this.getRayDetectNodes(o))}return t}localToWorldPosition(t){let i=cc.mat4(),o=cc.v3();return this.shape.getWorldMatrix(i),e.transformMat4(o,t,i),o}localToWorldDir(t){let i=cc.mat4(),o=cc.v3();return this.shape.getWorldMatrix(i),e.transformMat4Normal(o,t,i),e.normalize(o,o),o}worldPosToScreenPos(e){let t=s._camera._camera,i=cc.v2();return t.worldToScreen(i,e,cc.visibleRect.width,cc.visibleRect.height),i}getScreenPos(e){return this.worldPosToScreenPos(this.localToWorldPosition(e))}getAlignAxisMoveDistance(i,o){let s=e.add(v,this._position,i),r=this.worldPosToScreenPos(s),n=this.worldPosToScreenPos(this._position);return t.sub(r,r,n),t.normalize(r,r),t.dot(o,r)}show(){this.shape.active=!0,this.onShow&&this.onShow()}hide(){this.shape.active=!1,this.onHide&&this.onHide()}get visible(){return this.shape.active}onDimensionChanged(){this.visible&&this.show()}onScale2DChanged(){this.visible&&this.adjustControllerSize()}};