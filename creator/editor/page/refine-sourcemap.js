const e=require("fire-fs"),n=require("fire-path"),o=require("source-map"),r=o.SourceMapConsumer,t=o.SourceMapGenerator,i=require("event-stream");function u(o,i,u){if(o.sourceMap){let a=o.sourceMap,s=function(o,t,i){let u={};for(let a=0;a<o.sources.length;++a){let s=o.sources[a],l=n.resolve(i,s);l=t[l]||t[l.toLowerCase()]||l;let c="";try{c=e.readFileSync(l+".map","utf8")}catch(r){let u=n.basenameNoExt(l);if(Editor.Utils.UuidUtils.isUuid(u)){let r=Editor.assetdb.remote.uuidToFspath(u);if(r&&(l=t[r]||t[r.toLowerCase()])){try{c=e.readFileSync(l+".map","utf8")}catch(e){}s=o.sources[a]=n.relative(i,r)}}if(!c)continue}let g=new r(c);u[s]=g}return u}(a,i,u);o.sourceMap=function(e,n){var o=new r(n),i=new t,u={line:0,column:0,bias:r.LEAST_UPPER_BOUND},a={original:null,generated:{line:0,column:0},source:"",name:""};o.eachMapping(function(n){if(null==n.originalLine)return;let o=n.source,r=e[o];if(!r)return;u.line=n.originalLine,u.column=n.originalColumn;let t=r.originalPositionFor(u);null!=t.source&&(a.original=t,a.generated.line=n.generatedLine,a.generated.column=n.generatedColumn,a.source=o,a.name=n.name,i.addMapping(a))});var s=JSON.parse(i.toString());s.sourcesContent=[],s.sourceRoot=n.sourceRoot;for(let n=0;n<s.sources.length;++n){let o=s.sources[n],r=e[o];r&&(s.sourcesContent[n]=r.sourcesContent[0])}return s}(s,a)}else Editor.error("gulp-sourcemaps not initialized")}module.exports=function(e,n){return i.through(function(o){u(o,e,n),this.emit("data",o)})},module.exports.offsetLines=function(e,n){var o=new r(e),i=new t({file:e.file,sourceRoot:e.sourceRoot});o.eachMapping(function(o){o.source||(o.source=e.sources[0]),"number"==typeof o.originalLine&&0<o.originalLine&&"number"==typeof o.originalColumn&&0<=o.originalColumn&&o.source&&i.addMapping({source:o.source,name:o.name,original:{line:o.originalLine,column:o.originalColumn},generated:{line:o.generatedLine+n,column:o.generatedColumn}})});var u=JSON.parse(i.toString());return void 0!==e.sourcesContent&&(u.sourcesContent=e.sourcesContent),u};