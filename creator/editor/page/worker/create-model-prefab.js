require("electron").ipcRenderer,require("util");const e=require("fire-fs"),t=require("fire-path");async function i(e){let t=Editor.url(e);return Editor.remote.assetdb.assetInfoByPath(t).uuid}module.exports=async function(r){const o=Editor.require("app://editor/page/scene-utils/utils/prefab"),n=Editor.require("app://editor/page/scene-utils/utils/node"),l=Editor.require("unpack://engine-dev/cocos2d/core/3d/skeleton/CCSkinnedMeshRenderer"),s=Editor.require("unpack://engine-dev/cocos2d/core/3d/skeleton/CCSkeletonAnimation"),a=Editor.require("unpack://engine-dev/cocos2d/core/mesh/CCMeshRenderer"),d=Editor.require("unpack://engine-dev/cocos2d/core/3d/CCModel");let{gltf:c,meshIDs:u,skeletonIDs:f,modelUuid:m,materiaIDs:p,modelName:h,modelPath:g,scaleFactor:_}=r;function C(i,r,o){let n="",l=[t.join(t.dirname(g),i)];for(let e=0;e<r.length;e++){let o=t.join(t.dirname(g),r[e],i);l.push(o)}if(o){let e=t.basenameNoExt(i)+o;if(i!==e){let i=l.map(i=>t.join(t.dirname(i),e));l=l.concat(i)}}for(let t=0;t<l.length;t++){let i=l[t];if(e.existsSync(i)&&(n=Editor.remote.assetdb.fspathToUuid(i)))break}return n}let b=[],E=[],k=c.materials||[];for(let e=0;e<k.length;e++){let t=k[e],r=C(t.name+".mtl",["materials","Materials"]);if(r){let t=new cc.Material;t._uuid=r,E[e]=t}let o,n=new cc.Material;b.push(n),n._uuid=p[e];let l=t.pbrMetallicRoughness;if(l){if(l.baseColorTexture){let e=c.textures[l.baseColorTexture.index];if(e){let t=c.images[e.source].uri;if(t.startsWith("data:image/ccmissing;base64,")&&(t=(t=(t=window.atob(t.replace("data:image/ccmissing;base64,",""))).split("\\").pop()).split("/").pop()),o=C(t,["textures","Textures"],".png")){var v=new cc.Texture2D;v._uuid=o,n._props.diffuseTexture=v,n._defines.USE_DIFFUSE_TEXTURE=!0}}}if(o)n._props.diffuseColor=cc.color(255,255,255,255);else{let e=l.baseColorFactor;if(e){let t=void 0===e[0]?255:255*e[0],i=void 0===e[1]?255:255*e[1],r=void 0===e[2]?255:255*e[2],o=void 0===e[3]?255:255*e[3];n._props.diffuseColor=cc.color(t,i,r,o)}}}n._effectAsset=new cc.EffectAsset,n._effectAsset._uuid=await i("db://internal/effects/builtin-phong.effect")}let M=[],q={},w=c.nodes;for(let e=0;e<w.length;e++){let t=w[e],i=new cc.Node;i.is3DNode=!0,i.name=t.name;let r=t.position;r&&i.setPosition(r[0],r[1],r[2]);let o=t.quat;o&&i.setRotation(o[0],o[1],o[2],o[3]);let n=t.scale;if(n&&i.setScale(n[0],n[1],n[2]),void 0!==t.mesh){let e,r=new cc.Mesh;if(r._uuid=u[t.mesh],void 0!==t.skin){e=i.addComponent(l);let r=new cc.Skeleton;r._uuid=f[t.skin],e._skeleton=r}else e=i.addComponent(a);e.mesh=r,e.sharedMaterials=[];let o=c.meshes[t.mesh].primitives;e.sharedMaterials.length=o.length;for(let t=0;t<o.length;t++){let i=o[t];e.sharedMaterials[t]=E[i.material]||b[i.material]}}M.push(i)}let x=!1;for(let e=0;e<M.length;e++){let t=M[e],i=w[e].children;if(i)for(let e=0;e<i.length;e++)M[i[e]].parent=t;let r=t.getComponent(l);r&&(r._rootBone=M[0],x=!0)}let T=M[0];if(x){let e=T.addComponent(s),t=new d;t._uuid=m,e._model=t}T.scale=_;let S=function(){let e=Object.create(null);return function(t){let i=e[t];return void 0===i?(e[t]=1,t):(e[t]=++i,t+"_"+i)}}(),D=n.getNodePath(T).length+1,N=o.createPrefabFrom(T,e=>{if(e===T)return m;let t=n.getNodePath(e),i=t.slice(D,t.length);return S(i)});N.name=h;let P=Editor.serialize(N);return q[h]=P,{nodeMap:q,materials:b.map(e=>e.serialize())}};