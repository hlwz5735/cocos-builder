(()=>{"use strict";const{promisify:e}=require("util");require("electron").ipcRenderer.on("app:compile-worker-start",function(r,t){const i=require("fire-path"),o=(require("async"),require("globby")),a=require("gulp"),n=require("del"),s=require("fire-fs");Editor.isDarwin&&require("graceful-fs").gracefulify(require("fs"));var u=t.cacheDir?null:require("browserify"),l=t.cacheDir?require("persistify"):null;const c=require("vinyl-source-stream"),d=require("vinyl-buffer"),p=require("gulp-sourcemaps"),f=Editor.require("unpack://engine/gulp/util/utils").uglify,m=Editor.require("app://editor/page/refine-sourcemap");var g=require("gulp-sequence").use(a);const b=s.readFileSync(Editor.url("unpack://static/_prelude.js"),"utf8");window.onerror=function(e,r,t,i,o){window.onerror=null;var n=o.stack||o;if(Editor&&Editor.Ipc&&Editor.Ipc.sendToMain&&Editor.Ipc.sendToMain("metrics:track-exception",n),a&&a.isRunning)return a.stop(o),!0;Editor&&Editor.Ipc&&Editor.Ipc.sendToMain&&Editor.Ipc.sendToMain("editor:renderer-console-error",n)},Editor.require("app://editor/share/editor-utils"),Editor.require("app://editor/page/asset-db");var h="library/imports",y="Compile error:",E="Cannot find module ";t.dest=t.dest||"library/bundle.js",t.platform=t.platform||"editor",t.debug=!!t.debug,t.sourceMaps="sourceMaps"in t?t.sourceMaps:t.debug;const v="wechatgame-subcontext"===t.platform,q="wechatgame"===t.platform||v;var w={destRoot:t.destRoot,dest:t.dest,destDir:i.dirname(t.dest),proj:i.resolve(t.project),subpackages:t.subpackages};w.dest=i.resolve(w.proj,w.dest);t.platform;if(i.contains(Editor.appPath,w.proj)){return r.reply(null,new Error(`${y} Invalid project path: ${t.project}`).stack),void 0}console.log("Compiling "+w.proj);var k={},j={};function _(e){return i.basenameNoExt(e)}a.task("do-clean",async function(){var e=i.join(i.dirname(w.dest),i.basenameNoExt(w.dest))+i.extname(w.dest);try{await n(e,{force:!0})}catch(r){throw Editor.error(`Failed to delete ${e}, press [F7] to try again.`),r}}),a.task("clean",["do-clean"],function(e){setTimeout(e,100)});let x={},$=[],M={},N={},C=[];function T(e,r,o,n){var s,g=w.proj,h={debug:t.sourceMaps,basedir:g,builtins:["assert","buffer","console","constants","crypto","domain","events","http","https","os","path","punycode","querystring","stream","_stream_duplex","_stream_passthrough","_stream_readable","_stream_transform","_stream_writable","string_decoder","sys","timers","tty","url","util","vm","zlib","_process"],extensions:[".ts",".coffee"],ignoreMissing:!0,externalRequireName:"window.__require",prelude:b};e.sort(),function(e){if(!e._bresolve){let e=new Error("Failed to patch browserify");return a.isRunning&&a.stop(e),void 0}e.__bresolve=e._bresolve,e._bresolve=function r(t,o,a){e.__bresolve(t,o,function(e,n,s){if(e){if(o&&o.filename){var u=j[o.filename]||j[o.filename.toLowerCase()];if(u)return o.filename=u,o.basedir=i.dirname(u),r(t,o,a);console.warn(`Failed to resolve script "${t}" in raw directory: `,o)}return a(null,n,s)}var l=k[n];return l||(l=k[n.toLowerCase()])&&console.log(`resolve "${t}" to "${l}" by ignoring case mistake`),a(null,n=l||n,s)})}}(s=t.cacheDir?l(h,{recreate:t.recreateCache,cacheId:t.platform+"_"+!!t.debug+"_"+!!t.sourceMaps,cacheDir:t.cacheDir}):new u(h));for(let r=0;r<e.length;++r){var v=e[r];s.add(v),s.require(v,{expose:i.basenameNoExt(v)})}for(let r=0;r<$.length;++r){let t=$[r];-1===e.indexOf(t)&&s.exclude(k[t.toLowerCase()])}var q=s.bundle().on("error",function(e){e=new Error(function(e){function r(e,r,t){if(e.startsWith(r)){if(!t)return e.slice(r.length);if(e.endsWith(t))return e.slice(r.length,-t.length)}return""}var t,o=(e.message||e.toString()).trim();if(!o)return e;if(t=r(o,"ENOENT, open '",".js'")){let e=i.basenameNoExt(t);return`${y} Cannot require '${e}', module not found, ${o}`}if(t=r(o,"ENOENT: no such file or directory, open '",".js'")){let e=i.basenameNoExt(t);return`${y} Cannot require '${e}', module not found, ${o}`}if(r(o,E)){let e=E.length+1,r=o.indexOf("'",e);if(-1===r)return o;let t=o.slice(e,r);if(i.basename(t)===t&&i.extname(t))return`${y} Cannot require '${t}', module not found, please remove file extension and retry. ( just "require('${i.basenameNoExt(t)}');"`;o=o.replace(E,"Cannot require ")+". Module not found."}return e.annotated&&(o=o+"\n"+e.annotated),y+" "+o}(e)),a.isRunning&&a.stop(e)}).pipe(c(o));q=q.pipe(d()),t.sourceMaps&&(q=q.pipe(p.init({loadMaps:!0})));var _=Editor.require("app://editor/share/build-platforms")[t.platform].isNative,x="runtime"===t.platform;q=q.pipe(f("build",{jsb:_&&!x,runtime:x,wechatgame:"wechatgame"===t.platform,baidugame:"baidugame"===t.platform,qqplay:"qqplay"===t.platform,debug:t.debug})),t.sourceMaps&&(q=q.pipe(m(k,g)).pipe(p.write("./"))),(q=q.pipe(a.dest(r))).on("end",n)}a.task("query-sub-packages",function(r){Editor.remote.assetdb.queryMetas("db://assets/**","folder",async(t,o)=>{if(t)return Editor.error(t);o=o.filter(e=>e.isSubpackage);for(let t=0;t<o.length;++t){let a=o[t],n=Editor.assetdb.remote.uuidToFspath(a.uuid),s=a.subpackageName||i.basenameNoExt(n),u=Editor.remote.assetdb.uuidToUrl(a.uuid)+"/**/*",l=i.join("subpackages",s)+"/";N[s]={name:s,path:l.replace(/\\/g,"/")},M[s]||(M[s]=[]);let c=null;try{c=await e(Editor.remote.assetdb.queryAssets.bind(Editor.remote.assetdb))(u,null)}catch(e){return r(e)}c=c.filter(e=>"javascript"===e.type||"typescript"===e.type);for(let e=0;e<c.length;++e){let r=c[e],t=Editor.assetdb.remote.uuidToFspath(r.uuid);M[s].push(t)}}r()})}),a.task("get-scripts",function(e){(function(e){var r=i.join(h,"**/*.js"),t=w.proj,a={cwd:t};function n(e){return i.relative(a.cwd,e)}function s(e,r,t){e[r]=t;let i=r.toLowerCase();i in e||(e[i]=t)}o(r,a,(r,o)=>{if(r)return e(r);for(var a=0;a<o.length;a++){var u=o[a],l=_(u),c=Editor.assetdb.remote.uuidToFspath(l);if(!c){Editor.warn("Can not get fspath of: "+l+" from assetdb, but script found in library.");continue}var d=i.resolve(t,u);s(j,d,c),s(k,c,d);var p=i.basenameNoExt(c),f=x[p];if(f){var m=n(c),g=n(f),b=new Error(`${y} Filename conflict, the module "${p}" both defined in "${m}" and "${g}"`);return e(b)}x[p]=c;let r=!1;for(let e in M){let t=M[e];for(let e=0;e<t.length;e++)if(i.contains(t[e],c)){r=!0;break}}r||C.push(c),$.push(c)}e()})})(e)}),a.task("browserify-main-package",function(e){console.log("Output main package : "+w.dest);let r=i.basename(w.dest);T(C,w.destDir,r,function(){e()})}),a.task("browserify-sub-packages",async r=>{for(let t in M){let o=M[t],a=i.join(w.subpackages,t),n="index.js";q&&(n="game.js"),console.log("Output sub package : "+i.join(a,n));try{await e(T)(o,a,n)}catch(e){return r(e)}}r()}),a.task("compile",g("clean","query-sub-packages","get-scripts","browserify-main-package","browserify-sub-packages")),a.start("compile",function(e){if(e){var t=Editor.Utils.toString(e);if("string"==typeof e.stack){if(!(e=e.stack).startsWith(t)){var i=/^.*/.exec(t)[0];e.startsWith(i)&&(e=(e=e.slice(i.length)).trimLeft()),e=t+"\n"+e}e.startsWith("Error: "+y)&&(e=e.slice("Error: ".length))}else e=t}r.reply(null,e,N),console.log("Compile Worker Finished")})})})();