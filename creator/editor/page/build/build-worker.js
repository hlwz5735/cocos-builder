(()=>{"use strict";0;const e=require("electron").ipcRenderer;var t,i,r,n,o;window.onerror=function(e,t,i,r,n){window.onerror=null;var o=n.stack||n;Editor&&Editor.Ipc&&Editor.Ipc.sendToMain&&(Editor.Ipc.sendToMain("app:build-project-abort",o),Editor.Ipc.sendToMain("metrics:track-exception",o))},window.addEventListener("unhandledrejection",function e(t){window.removeEventListener("unhandledrejection",e),window.onerror(void 0,void 0,void 0,void 0,t.reason)}),e.on("app:init-build-worker",function(e,s,a){t=require("path"),require("fire-fs"),require("gulp"),require("event-stream"),i=require("async"),r=require("lodash"),n=require("../../share/build-platforms"),Editor.isBuilder=!0,window.CC_TEST=!1,window.CC_EDITOR=!0,window.CC_PREVIEW=!1,window.CC_DEV=!1,window.CC_DEBUG=!0,window.CC_BUILD=!1,window.CC_JSB=!1,Editor.require("app://editor/share/editor-utils"),Editor.require("unpack://engine-dev"),Editor.require("app://editor/share/engine-extends/init"),Editor.require("app://editor/share/engine-extends/serialize"),Editor.require("app://editor/page/asset-db"),Editor.require("app://editor/share/register-builtin-assets");const d=require(Editor.url("app://editor/page/project-scripts"));o=Editor.remote.importPath;var u=!n[s].exportSimpleProject;i.waterfall([function(e){cc.AssetLibrary.init({libraryPath:o});var t=document.createElement("canvas");document.body.appendChild(t),t.id="engine-canvas",cc.game.run({width:800,height:600,id:"engine-canvas",jsList:[],debugMode:cc.debug.DebugMode.INFO},e)},Editor.Utils.asyncif(u,d.load.bind(d))],t=>{e.reply(t||null)})}),e.on("app:build-assets",function(e,s,a,d,u){var c,l,p=4,f=n[a],E=f.pack,w=t.join(s,"import"),m=require("./file-writer"),b=require("./asset-crawler"),h=require("./build-asset"),g=require("./group-manager"),q=require("./group-strategies"),v=require("./texture-packer"),k=require("./building-assetdb"),y=new m(w,d),x=new k(Editor.assetdb),C=new v;if(f.isNative){if(u.mergeStartScene=!1,u.optimizeHotUpdate)u.inlineSpriteFrames=!1;else{u.inlineSpriteFrames&&Editor.info('Enable "%s" in native platform will increase the package size used in hot update.',Editor.T("BUILDER.merge_asset.inline_SpriteFrames"))}E=E&&(u.optimizeHotUpdate||u.inlineSpriteFrames)}E&&(l=f.isNative?u.optimizeHotUpdate?new q.ForHotUpdate:new q.GroupStrategyBase:new q.SizeMinimized,console.log("group strategy:",cc.js.getClassName(l)),c=new g(y,d,l,x,r.pick(u,"inlineSpriteFrames","mergeStartScene")));var U,T,S,I=new h(y,o,x,a),_=new b(I,p,C);var j=[e=>{console.time("queryResources"),e(null)},function(e){var t=[],i=!1,r=!1;Editor.assetdb.queryAssets("db://assets/resources/**/*",null,function(n,o){t=t.concat(o),r?e(n,t):i=!0}),Editor.assetdb.queryAssets("db://internal/resources/**/*",null,function(n,o){t=t.concat(o),i?e(n,t):r=!0})},(e,t)=>{console.timeEnd("queryResources"),console.time("startAssetCrawler"),t(null,e)},function(e,t){var i=e.filter(e=>"folder"!==e.type&&"javascript"!==e.type&&"typescript"!==e.type).map(e=>e.uuid),n=u.scenes;U=r.uniq(n.concat(i)),_.start(U,t)},(e,t)=>{console.timeEnd("startAssetCrawler"),t(null,e)},function(e,t){T=e,t(null)}];1,j=[].concat(function(e){Editor.assetdb.queryAssets("db://assets/**/*.pac",null,e)},function(e,t){C.init({files:e,writer:y,platform:a}).then(t).catch(t)},j,function(e){Editor.Ipc.sendToMain("builder:state-changed","pack-textures",.7),console.time("pack textures"),C.pack(T).then(t=>{let{unpackedTextures:i,packedSpriteFrames:n,packedTextures:o}=t,s=i.map(e=>e.textureUuid),a=r.pullAll(C.textureUuids,s);for(let e in n)T[e]={dependUuids:[n[e]]};for(let e in o){let t=o[e];T[e]={nativePath:t},x.addGeneratedAsset(e,t,"texture",!1)}let d=[],u=C.texture2pac;if(a.length>0)for(let e in T){let t=T[e];if("object"!=typeof t)continue;let i=t.dependUuids;if(i)for(let t=0,r=i.length;t<r;t++){let r=i[t];if(-1!==a.indexOf(r)&&-1===d.indexOf(r)){d.push(r);let t=Editor.assetdb.remote.uuidToUrl(r),i=u[r].relativePath,n=Editor.assetdb.remote.uuidToUrl(e);Editor.warn(Editor.T("BUILDER.error.keep_raw_texture_of_atlas",{texturePath:t,pacPath:i,assetPath:n}))}}}if(r.pullAll(U,C.textureUuids),i.length>0||d.length>0){let t=i.map(e=>{let t=Editor.assetdb.remote.uuidToUrl(e.textureUuid);return Editor.warn(`${t} has not been packed into AutoAtlas.`),e.uuid}).concat(d);new b(I,p).start(t,(t,i)=>{if(t)return e(t);Object.assign(T,i),e()}),U=r.uniq(U.concat(t))}else e();console.timeEnd("pack textures"),E?Editor.Ipc.sendToMain("builder:state-changed","pack-assets",.8):Editor.Ipc.sendToMain("builder:state-changed","build-assets",.8)}).catch(t=>e(t))}),E&&j.push(function(e){console.time("init packs"),c.initPacks(U,T,u.scenes[0],e)},function(e){console.timeEnd("init packs"),console.time("build packs"),c.buildPacks(e)},function(e,t){console.timeEnd("build packs"),S=e.packedAssets,t()}),j.push(function(e){y.flush(e)}),i.waterfall(j,function(t){if(t)(t=t&&t.stack)instanceof Error||(t=new Error(t)),e.reply(t);else{console.log("finished build-worker"),U.forEach(e=>{var t=T[e];"object"!=typeof t?T[e]={isRoot:!0}:t.isRoot=!0});e.reply(null,T,S)}})})})();