"use strict";var e=cc.Font;const s=!1,i=require("path"),t=require("fire-fs"),r=require("../../share/build-platforms"),a=require("../scene-utils/missing-class-reporter").MissingClass,o=Editor.require("app://editor/page/build/texture-compress"),{promisify:l}=require("util");l(t.readFile),l(t.copy);class d{constructor(e,s,i,t){this.writer=e,this.library=s,this.assetdb=i;var a=r[t];this.platform=t,this.isJSB=a.isNative,this.exportSimpleFormat=!a.stripDefaultValues||a.exportSimpleProject,this.shouldExportScript=!a.exportSimpleProject,this.deserializeDetails=new cc.deserialize.Details,this.existsCache={},this._bindedGetAssetRef=this._getAssetRef.bind(this),this.uuid2meta=Editor.remote.assetdb._uuid2meta}build(e,s){this.assetdb.queryInfoByUuid(e,(i,t)=>{if(!t)return this.existsCache[e]=!1,s(new Error(d.AssetMissing));this.existsCache[e]=!0;var r=t.type;return r?"folder"===r?(console.warn("Should not build folder"),s()):(this._buildAsset(e,s),void 0):s(new Error("Asset type not specified "+t.url))})}_exportNativeAsset(e,s){let r=e.nativeUrl,a=i.relative(this.library,r),l=i.join(this.writer.dest,"..","raw-assets",a);if(e instanceof cc.Texture2D){let t=this.uuid2meta[e._uuid];o({src:r,dst:l,platform:this.platform,compressOption:t.platformSettings},(t,r)=>{t&&Editor.error(t),r&&r.length>0?e._exportedExts=r:e._exportedExts=[i.extname(l)],s(null,l)})}else{try{t.copySync(r,l)}catch(e){return Editor.error("Failed to copy native asset file %s to %s,",r,l,e),s(null,"")}s(null,l)}}_getAssetRef(e){var s=this.existsCache[e];return void 0===s&&(s=this.existsCache[e]=!!Editor.assetdb.remote.uuidToFspath(e)),s?Editor.serialize.asAsset(e):null}_buildAsset(r,o){var l=i.join(this.library,r.slice(0,2),r+".json"),d=t.readFileSync(l);s&&console.log("building "+l),this.deserializeDetails.reset(),a.hasMissingClass=!1;var n=cc.deserialize(d,this.deserializeDetails,{ignoreEditorOnly:!0,classFinder:a.classFinder});n._uuid=r,a.hasMissingClass&&this.shouldExportScript&&a.reportMissingClass(n),this.deserializeDetails.assignAssetsBy(this._bindedGetAssetRef);var u,h=this.deserializeDetails.uuidList.slice();h.length>0&&(u=this.deserializeDetails.uuidObjList.slice()),n._native&&(this.isJSB||!n.constructor.preventPreloadNativeObject||n instanceof e)?this._exportNativeAsset(n,(e,s)=>{this._doBuildJson(n,h,u,s,o)}):this._doBuildJson(n,h,u,void 0,o)}_doBuildJson(e,s,i,t,r){var a=Editor.serialize(e,{exporting:!0,nicify:!this.exportSimpleFormat,stringify:!1,dontStripDefault:this.exportSimpleFormat});this.writer.writeJsonByUuid(e._uuid,a,e=>e?r(e):r(null,{dependUuids:s,ownersForDependUuids:i,nativePath:t}))}}d.AssetMissing="asset missing",module.exports=d;