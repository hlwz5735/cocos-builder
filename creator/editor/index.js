"use strict";const{promisify:t}=require("util"),i=require("path"),r=require("electron"),e=require("fire-fs"),o=require("semver");process.on("unhandledRejection",t=>{console.error(t)}),exports.startup=async function(t,d){if(require("./init"),global.Editor=require("./lib/editor"),await Editor.Network.update(),Editor.Network.isOnline&&!Editor.argv.nologin||Editor.User.enable(!1),!Editor.argv._command)try{let t=await Editor.Project.check();if(t&&t.abort)return r.app.quit(),void 0;await Editor.Project.init()}catch(t){return d(t),void 0}try{await Editor.Engine.build()}catch(t){await Editor.Engine.revertEngineDialog(t),await Editor.Engine.build()}try{await Editor.Engine.init(),await Editor.Engine.initExtends()}catch(t){return d(t)}await a(),function(){let t,r=i.join(Editor.Project.path,"project.json");try{t=e.readJsonSync(r)}catch(t){return console.error(t)}let a=t.version;if((!a||o.satisfies(a,"< "+Editor.versions.CocosCreator,{includePrerelease:!0}))&&(console.log("migrating project from "+(a||"< 2.1.2")),Editor.Ipc.sendToMain("migrate-project",a)),t.version=Editor.versions.CocosCreator,!t.id){const i=require("node-uuid");t.id=i.v4()}try{e.writeFileSync(r,JSON.stringify(t,null,2))}catch(t){console.error(t)}}();try{await n()}catch(t){return d(t)}try{Editor.AssetDB.loading=!0,await Editor.AssetDB.mountInternal(),await Editor.AssetDB.mountExternal(),await Editor.AssetDB.mountMain(),await Editor.AssetDB.init(),Editor.AssetDB.loading=!1}catch(t){return Editor.AssetDB.loading=!1,d(t)}let s=require("../share/engine-utils");Editor.builtinCocosRoot=s.getEnginePath();try{await Editor.Engine.initSceneList()}catch(t){return d(t)}Editor.MainMenu.add(Editor.T("MAIN_MENU.node.title"),Editor.Menu.getMenu("create-node"));const c=require("./share/build-jsb-adapter");return await c.prebuild({rootPath:Editor.url("packages://jsb-adapter"),dstPath:Editor.url("packages://jsb-adapter/bin")}),await new Promise((t,i)=>{Editor.QuickCompiler.init(t)}),"string"==typeof Editor._buildCommand?(await new Promise((t,i)=>{Editor.Builder.buildCommand(Editor._buildCommand,e=>{if(e)return Editor.error(e),r.app.exit(1),i(e),void 0;r.app.quit(),t()})}),void 0):"string"==typeof Editor._compileCommand?(await new Promise((t,i)=>{Editor.Builder.compileCommand(Editor._compileCommand,e=>{if(e)return Editor.error(e),r.app.exit(1),i(e),void 0;r.app.quit(),t()})}),void 0):(d(),void 0)};let a=async function(){Editor.argv._command||await t(Editor.loadAllPackages)()},n=function(){if(!Editor.argv._command)try{require("./share/register-builtin-assets"),require("./core/init-builtin-assets")}catch(t){throw Editor.Dialog.messageBox({type:"error",buttons:["OK"],title:"Register builtin assets failed",message:"Maybe the reason is: You are using custom JS engine and it is out-dated.",detail:`Error call stack : ${t.stack}`,defaultId:0,cancelId:0,noLink:!0}),t}};