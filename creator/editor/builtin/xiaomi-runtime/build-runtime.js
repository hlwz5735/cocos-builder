const e=require(Editor.url("packages://xiaomi-runtime/lib/utils"));var i=require("fire-path"),a=require("fire-fs"),t=require("del"),{promisify:r}=require("util");let o;var n,s,m,c,u,l;async function d(e,s){try{await async function(e){let o=Editor.url("packages://xiaomi-adapter/node_modules"),n=i.join(e.dest,"node_modules");try{let r=a.readFileSync(Editor.url("packages://xiaomi-adapter/package.json"),"utf8"),o=a.readFileSync(i.join(e.dest,"package.json"),"utf8");if(r!==o)Editor.log("Removing old node_modules..."),await t(i.join(n,"**/*"),{force:!0});else if(a.existsSync(n))return}catch(e){}Editor.log("Copying node_modules, please wait ...");let s=r(a.copy);try{await s(Editor.url("packages://xiaomi-adapter/package.json"),i.join(e.dest,"package.json")),await s(o,n)}catch(e){Editor.error("Copy node_module failed",e)}}(s),function(e){let t=e.dest;Editor.log("Copy xiaomi project files"),a.copySync(o.icon,i.join(t,"image",i.parse(o.icon).base)),a.copySync(Editor.url("packages://xiaomi-adapter/xiaomigame"),t);let r=o.useDebugKey?i.join(Editor.url("packages://xiaomi-adapter/certificate"),"certificate.pem"):o.certificatePath,n=o.useDebugKey?i.join(Editor.url("packages://xiaomi-adapter/certificate"),"private.pem"):o.privatePath;a.copySync(r,i.join(t,`sign/${e.debug?"debug":"release"}/certificate.pem`)),a.copySync(n,i.join(t,`sign/${e.debug?"debug":"release"}/private.pem`))}(s),function(e){let t=e.buildResults._subpackages;if(!t)return;for(let r in t){let o=t[r],n=i.join(e.dest,o.path,"index.js");a.existsSync(n)&&a.renameSync(n,i.join(e.dest,o.path,"main.js"))}}(s),function(e){Editor.log("Write manifest");let t=e.dest,r=i.join(t,"manifest.json"),s=o.package,m=o.name,c=o.versionName,u=o.versionCode,l=o.minPlatformVersion,d=o.deviceOrientation,p=o.logLevel,g={package:s,name:m,icon:`/image/${i.parse(n).base}`,versionName:c,versionCode:u,minPlatformVersion:l,orientation:d,type:"game",config:{logLevel:p},display:{}},f=e.buildResults._subpackages;if(f&&Object.keys(f).length>0){g.subpackages=[];for(let e in f){let i=f[e];g.subpackages.push({name:i.name,root:i.path})}}let y=JSON.stringify(g,null,4);a.writeFileSync(r,y)}(s),function(e){if(!o.tinyPackageServer)return;let t=i.join(e.dest,"main.js"),r=a.readFileSync(t,"utf8");if(!r)return;let n='miDownloader.REMOTE_SERVER_ROOT = "'+o.tinyPackageServer+'"';r=r.replace(/miDownloader.REMOTE_SERVER_ROOT = ""/g,n),a.writeFileSync(t,r,"utf8")}(s),function(){if(o.useDebugKey||o.package.indexOf("test")||o.name.indexOf("test")||u||l)return;Editor.Metrics.trackEvent("Project","BetaPlatforms","xiaomi-runtime",{packageName:o.package,appName:o.name,version:o.versionName,orientation:o.deviceOrientation})}(),e.reply()}catch(i){e.reply(i)}}module.exports={name:Editor.T("xiaomi-runtime.platform_name"),platform:"xiaomi",extends:"mini-game",buttons:[Editor.Builder.DefaultButtons.Build,{label:Editor.T("BUILDER.play"),message:"play"}],messages:{"script-build-finished":async function(e,i){var t=Editor.Profile.load("profile://project/xiaomi-runtime.json"),r=(o=t.data).package,p=o.name,g=o.icon,f=o.versionName,y=o.versionCode,x=o.minPlatformVersion;u=i.debug,l=i.sourceMaps,n=g||"",n=g.trim(),s=o.privatePath||"",m=o.certificatePath||"",c=o.useDebugKey;var E=!0,v=[],k="";if([{name:Editor.T("xiaomi-runtime.package"),value:r},{name:Editor.T("xiaomi-runtime.name"),value:p},{name:Editor.T("xiaomi-runtime.desktop_icon"),value:g},{name:Editor.T("xiaomi-runtime.version_name"),value:f},{name:Editor.T("xiaomi-runtime.version_number"),value:y},{name:Editor.T("xiaomi-runtime.support_min_platform"),value:x}].forEach(function(e){e.value||(E=!1,v.push(e.name))}),E||(k+=v.join("、")+Editor.T("xiaomi-runtime.not_empty")),g&&(a.existsSync(n)||(E=!1,k+=g+Editor.T("xiaomi-runtime.icon_not_exist"))),c||(""===s?(E=!1,k+=Editor.T("xiaomi-runtime.select_private_pem_path")):a.existsSync(s)||(E=!1,k+=`${s} `+Editor.T("xiaomi-runtime.signature_not_exist")),""===m?(E=!1,k+=Editor.T("xiaomi-runtime.select_certificate_pem_path")):a.existsSync(m)||(E=!1,k+=`${m}`+Editor.T("xiaomi-runtime.signature_not_exist"))),!E)return e.reply(new Error(k)),void 0;await d(e,i)},"build-finished":async function(i,a){let t=a.debug,r=a.dest;Editor.log("Build rpk");let n=["quickgame",t?"build":"release","--cocos-wx-game"];o.tinyPackageServer&&n.push("--ignore","res");let s=null;try{await e.execCmd("win32"===process.platform?"npx.cmd":"npx",n,r)}catch(e){s=e}i.reply(s)},play:(e,i)=>{Editor.Panel.open("xiaomi-runtime.qrcode",i)}},settings:Editor.url("packages://xiaomi-runtime/build-runtime-ui.js")};