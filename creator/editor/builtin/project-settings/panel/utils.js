"use strict";const e=require("fire-fs"),{dirname:t,join:i}=require("path"),o=Editor.require("app://share/engine-utils");let r=null;exports.profiles={project:null,global:null,local:null},exports.init=function(){return Promise.resolve().then(()=>new Promise((e,t)=>{Editor.Profile.load("profile://project/project.json",(i,o)=>{if(i)return t(i);exports.profiles.project=o,e()})})).then(()=>new Promise((e,t)=>{Editor.Profile.load("profile://global/settings.json",(i,s)=>{if(i)return t(i);(function(e){let t=e.data["use-default-cpp-engine"];r=o.getSimulatorConfigAt(!t&&e.data["cpp-engine-path"])})(s),exports.profiles.global=s,e()})})).then(()=>new Promise((e,t)=>{Editor.Profile.load("profile://local/settings.json",(i,o)=>{if(i)return t(i);exports.profiles.local=o,e()})}))};exports.queryGroupList=function(){let e=[];return exports.profiles.project.data["group-list"]?(exports.profiles.project.data["group-list"].forEach(t=>{e.push(t)}),e):e},exports.queryCollision=function(){let e=exports.profiles.project.data["collision-matrix"]||[];return JSON.parse(JSON.stringify(e))},exports.queryExcluded=function(){let e=exports.profiles.project.data["excluded-modules"]||[];return JSON.parse(JSON.stringify(e))},exports.queryPreview=function(){return{scene:exports.profiles.project.data["start-scene"]||"current",resolutionWidth:exports.profiles.project.data["design-resolution-width"],resolutionHeight:exports.profiles.project.data["design-resolution-height"],fitWidth:exports.profiles.project.data["fit-width"],fitHeight:exports.profiles.project.data["fit-height"]}},exports.querySimulator=function(){if(!r)return null;let e,t=exports.profiles.project.data,i=t["use-project-simulator-setting"],o=t["simulator-orientation"]||r.isLandscape,s=t["simulator-resolution"]||{},n=t["use-customize-simulator"],l=r.simulator_screen_size.map((e,t)=>({index:t,width:e.width,height:e.height,title:e.title}));l.push({index:l.length,title:Editor.T("PREFERENCES.sim_res_custom"),custom:!0,width:s.width,height:s.height}),n?e=l.length-1:l.some((t,i)=>{if(t.width===s.width&&t.height===s.height)return e=i,!0})||(n=!0,e=l.length-1);return{type:i?"project":"global",direction:o?"horizontal":"vertical",resolution:e,resolutionList:l,width:s.width,height:s.height}},exports.queryEngine=function(){let e=exports.profiles.local.data,t=function(t,i){return void 0===e[t]?i:e[t]};return{useGlobalSetting:t("use-global-engine-setting",!0),useDefaultJsEngine:t("use-default-js-engine",!0),jsEnginePath:e["js-engine-path"]||"",useDefaultCppEngine:t("use-default-cpp-engine",!0),cppEnginePath:e["cpp-engine-path"]||""}},exports.queryFacebook=function(){let e=exports.profiles.project.data,t=e.facebook;return t||(t=e.facebook={}),{enable:t.enable,appID:t.appID,live:t.live,audience:t.audience}};exports.setGroupList=function(e){let t=exports.profiles.project.data,i=t["group-list"];for(i||(i=t["group-list"]=[]);i.length>e.length;)i.pop();e.forEach((e,t)=>{i[t]=e})},exports.setCollision=function(e){exports.profiles.project.data["collision-matrix"]=JSON.parse(JSON.stringify(e))},exports.setExcluded=function(e){exports.profiles.project.data["excluded-modules"]=JSON.parse(JSON.stringify(e))},exports.setPreview=function(e){let t=exports.profiles.project.data;"current"!==e.scene?t["start-scene"]=e.scene:delete t["start-scene"],t["design-resolution-width"]=e.resolutionWidth,t["design-resolution-height"]=e.resolutionHeight,t["fit-width"]=e.fitWidth,t["fit-height"]=e.fitHeight},exports.setSimulator=function(e){let t=exports.profiles.project.data;t["use-project-simulator-setting"]=!("project"!=e.type),t["simulator-orientation"]=!("horizontal"!=e.direction),t["use-customize-simulator"]=!!(e.resolution>=e.resolutionList.length-1),t["simulator-resolution"]={width:e.width,height:e.height};let i=r.init_cfg;if("global"===e.type){let t=exports.profiles.global.data,o=t["simulator-resolution"],r=e.resolutionList[o];i.width=r.width,i.height=r.height,i.isLandscape=t["simulator-orientation"]}else i.width=e.width,i.height=e.height,i.isLandscape=!("horizontal"!=e.direction)},exports.setEngine=function(e){let t=exports.profiles.local.data;t["use-global-engine-setting"]=e.useGlobalSetting,t["use-default-js-engine"]=e.useDefaultJsEngine,t["js-engine-path"]=e.jsEnginePath,t["use-default-cpp-engine"]=e.useDefaultCppEngine,t["cpp-engine-path"]=e.cppEnginePath},exports.setFacebook=function(e){let t=exports.profiles.project.data.facebook;t.enable=e.enable,t.appID=e.appID||"",t.live=e.live||{enable:!1},t.audience=e.audience||{enable:!1}},exports.save=function(){let i=exports.profiles.local.data;i["use-global-engine-setting"]&&(i=exports.profiles.global.data);let s=o.getSimulatorConfigPath(i["use-default-cpp-engine"]?void 0:i["cpp-engine-path"]);e.existsSync(t(s))?e.writeJsonSync(s,r,"utf-8"):Editor.warn("Sorry, save failed. Cannot find simulator config.json under "+s),exports.profiles.project.save(),exports.profiles.local.save(),Editor.Ipc.sendToAll("editor:project-profile-updated",exports.profiles.project.data)};