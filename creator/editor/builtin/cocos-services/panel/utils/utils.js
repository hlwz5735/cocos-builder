"use strict";const r=require("fire-fs"),e=require("path"),t=require("./jszip"),i=require("compressing"),n=require("watch");let o=y()+"/local/logs/service.log";var s;function c(t){r.existsSync(e.dirname(t))||c(e.dirname(t)),r.mkdirSync(t)}function a(t,i){var n=e.dirname(i);0==r.existsSync(n)&&c(n),r.copySync(String(t),String(i))}function l(e){var t;t=r.existsSync(e)?r.readFileSync(e,"utf8"):"{}";try{return JSON.parse(t)}catch(r){return null}}function d(e,t){var i=JSON.stringify(t,null,"\t");r.writeFileSync(e,i)}function f(e,t=!1){var i=[];return r.readdirSync(e).forEach(n=>{var o=e+"/"+n,s=r.statSync(o);s&&s.isDirectory()?(t&&i.push(o+"/"),i=i.concat(f(o,t))):i.push(o)}),i}function u(e,t,i){var n=f(e,!0),o=n.length,s=0,l="";for(var d of(0==r.existsSync(t)&&c(t),n)){if("/"===(l=d.replace(e,t)).charAt(l.length-1)?0==r.existsSync(l)&&c(l):a(d,l),i)i(++s/o*100|0)}}function p(e){if(r.existsSync(e)){for(var t of r.readdirSync(e)){var i=e+"/"+t;r.statSync(i).isDirectory()?p(i):r.unlinkSync(i)}r.rmdirSync(e)}}function h(){return Editor.isMainProcess?Editor.Project?Editor.Project:Editor.projectInfo:Editor.remote.Project?Editor.remote.Project:Editor.remote.projectInfo}function v(){return h().name}function y(){return h().path}module.exports={t:function(r,...e){return Editor.T(`cocos-services.${r}`,...e)},getLang:function(){return Editor.lang},getCreatorHomePath:function(){return Editor.isMainProcess?Editor.App.home:Editor.remote.App.home},getProjectInfo:h,getProjectPath:y,getProjectName:v,zip:function(r,t,n){var o=r.replace(e.dirname(r),"").substring(1),s=t?e.join(t,o+".zip"):e.join(e.dirname(r),o+".zip");i.zip.compressDir(r,s).then(()=>{n&&n(null,!0)}).catch(r=>{n&&n(r,!1)})},unzip:function(r,e,t){i.zip.uncompress(r,e).then(()=>{t(null)}).catch(r=>{t(r)})},mkdirs:c,copyDir:u,moveDir:function(r,e,t){u(r,e,t),p(r)},removeDir:p,walk:f,copyFile:a,readJson:l,saveJson:d,parseProjectJson:function(r,e,t=!1){var i=l(r);i.serviceClassPath||(i.serviceClassPath=[]);if(t)i.serviceClassPath.indexOf(e)<=-1&&i.serviceClassPath.push(e);else{var n=i.serviceClassPath.indexOf(e);n>=-1&&i.serviceClassPath.splice(n,1)}this.printLog(`insert array element to "${r}" node of serviceClassPath`),d(r,i)},insertCodeLine:function(e,t,i,n=!1){if(!r.existsSync(e))return;let o=r.readFileSync(e,"utf8").split("\n");for(let r=0;r<o.length;r++)if(o[r].match(t)){o.splice(n?r:r+1,0,i);break}r.writeFileSync(e,o.join("\n"))},appendCodeLine:function(e,t){if(!r.existsSync(e))return;let i=r.readFileSync(e,"utf8");i+=t,r.writeFileSync(e,i)},copyServicePackages:function(e){e.forEach(e=>{r.statSync(e.src).isDirectory()?(u(e.src,e.dst),this.printLog(`copy folder "${e.src} to "${e.dst}"`)):(a(e.src,e.dst),this.printLog(`copy file "${e.src} to "${e.dst}"`))})},deleteServicePackages:function(e){e.forEach(e=>{r.statSync(e.src).isDirectory()?(p(e.dst),this.printLog(`delete folder from "${e.dst}"`)):(r.existsSync(e.dst)&&r.unlinkSync(e.dst),this.printLog(`delete file from"${e.dst}"`))})},printLog:function(e,t=!1){s||(s=r.createWriteStream(o,{flags:"a"}));try{var i=`Cocos Service ${(new Date).toLocaleString()} ${v()}\t${e}\n\n`;t&&this.printToCreatorConsole("log",i),s.write(i)}catch(r){console.error(r)}},openUrlWithDefaultExplorer:function(r){require("electron").shell.openExternal(r)},printToCreatorConsole:function(r,e){var t="Cocos Service --- "+e;"log"===r?Editor.isMainProcess?Editor.log(t):Editor.Ipc.sendToMain("cocos-services:log",t):"error"===r?Editor.isMainProcess?Editor.error(t):Editor.Ipc.sendToMain("cocos-services:error",t):"info"===r?Editor.isMainProcess?Editor.info(t):Editor.Ipc.sendToMain("cocos-services:info",t):"warn"===r?Editor.isMainProcess?Editor.warn(t):Editor.Ipc.sendToMain("cocos-services:warnning",t):"success"===r?Editor.isMainProcess?Editor.success(t):Editor.Ipc.sendToMain("cocos-services:success",t):"failed"===r&&(Editor.isMainProcess?Editor.failed(t):Editor.Ipc.sendToMain("cocos-services:failed",t))},unzipWithProgress:function(e,i,n){var o=i;"/"!=o.charAt(o.length-1)&&(i+="/");var s=new t;try{r.readFile(e,function(e,t){if(e)throw n&&n(e,null),e;s.loadAsync(t).then(e=>{var t=[];for(var o in e.files)t.push(o);t.sort();var s=t.length,a=0;for(var o of t){var l=i+o;"/"===o.charAt(o.length-1)?0==r.existsSync(l)&&c(l):e.file(o).nodeStream().pipe(r.createWriteStream(l)).on("finish",function(){r.chmodSync(l,493)}),n&&n(null,{status:"unziping",progress:++a/s*100|0})}n&&n(null,{status:"complete",progress:100})})})}catch(r){n&&n(r,null)}},watch:n};