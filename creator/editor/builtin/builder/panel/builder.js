"use strict";const e=require("fire-fs"),t=require("fire-path"),r=require("electron"),a=require("node-uuid"),o=Editor.require("app://editor/share/build-platforms"),i=require(Editor.url("packages://builder/utils/event")),s=require(Editor.url("packages://builder/utils/module-events")),l=require(Editor.url("app://editor/share/build-utils")),d=require(Editor.url("packages://builder/panel/platform/android")),n=require(Editor.url("packages://builder/panel/platform/web-desktop")),u=require(Editor.url("packages://builder/panel/platform/web-mobile")),c=require(Editor.url("packages://builder/panel/platform/fb-instant-games")),p=require(Editor.url("packages://builder/panel/platform/android-instant")),m=require(Editor.url("packages://builder/panel/platform/wechatgame")),h=require(Editor.url("packages://builder/panel/platform/wechatgame-subcontext")),f=require(Editor.url("packages://builder/panel/platform/qqplay")),E=require(Editor.url("packages://builder/panel/platform/windows")),g=require(Editor.url("packages://builder/panel/platform/ios")),b=require(Editor.url("packages://builder/panel/platform/mac")),v=require(Editor.url("packages://builder/panel/platform/baidugame")),_=require(Editor.url("packages://builder/panel/platform/baidugame-subcontext")),k=require("electron").remote.dialog,{promisify:x}=require("util"),B=Editor.require("app://editor/page/feature-utils").load(),I=/^v?[0-9.]*(?:-p.[0-9]+)?$/,P={data:null,project:null,anysdk:null};let T=B&&B["xiaomi-runtime"]||!1,w=["web-mobile","web-desktop","fb-instant-games","android","android-instant","ios",B&&B["alipay-minigame"]||!1?"alipay":"HIDDEN","jkw-game","huawei","quickgame","qgame",T?"xiaomi":"HIDDEN","baidugame","baidugame-subcontext","wechatgame","wechatgame-subcontext","cocos-runtime","qqplay","mac","win32"];var D=function(e,t,r){return t=t||{},Object.keys(e).forEach(a=>{if(!r||-1===r.indexOf(a)){var o=e[a];"object"!=typeof o||Array.isArray(o)?t[a]=o:t[a]=D(o)}}),t};Editor.Panel.extend({style:e.readFileSync(Editor.url("packages://builder/panel/builder.css")),template:e.readFileSync(Editor.url("packages://builder/panel/builder.html")),messages:{"builder:state-changed":function(e,t,r){if(this._vm){if(this._vm.setSystemBarProgress("error"===t||"finish"===t?-1:r),r*=100,"error"===t)return this._vm.buildProgress=r,this._vm.buildState="failed",this._vm.task="",void 0;if("finish"===t)return this._vm.buildProgress=100,this._vm.buildState="completed",this._vm.task="",void 0;this._vm.buildProgress=r,this._vm.buildState=t}},"builder:events":function(e,t,...r){i.emit(t,...r)},"keystore:created":function(e,t){this._vm.data.keystorePath=t.path,this._vm.data.keystorePassword=t.password,this._vm.data.keystoreAlias=t.alias,this._vm.data.keystoreAliasPassword=t.aliasPassword},"asset-db:assets-deleted":function(e,t){this._vm.scenes=this._vm.scenes.filter(e=>t.find(t=>t.uuid!==e.value))},"asset-db:assets-moved":function(e,t){t.forEach(e=>{let t=this._vm.scenes.find(t=>t.value===e.uuid);t&&(t.text=e.url,t.checked=!t.checked,setTimeout(()=>{t.checked=!t.checked},0))})},"asset-db:assets-created":function(e,t){t.forEach(e=>{"scene"===e.type&&this._vm.scenes.push({value:e.uuid,text:e.url,checked:!0})})}},ready(){var i=this.profiles.local,B=this.profiles.project,T=D(i.data,{}),L=D(B.data,{});T.actualPlatform=T.actualPlatform||T.platform;let j={},y=[u,d,p,n,c,m,h,v,_,f,E,g,b],R=Editor.remote.Builder.simpleBuildTargets;for(let e in R){let t=R[e];if(t.settings){let e=require(t.settings);!e.name&&(e.name=t.platform),y.push(e)}else Editor.warn("Can not load package",t.name)}y.forEach(e=>{e.props||(e.props={});for(let t in P)!e.props[t]&&(e.props[t]=P[t]);j[e.name]=e});var U=this._vm=new window.Vue({el:this.shadowRoot,data:{platforms:function(e){let t=[];t.push({value:"web-mobile",text:Editor.T("BUILDER.platforms.web-mobile")}),t.push({value:"web-desktop",text:Editor.T("BUILDER.platforms.web-desktop")}),t.push({value:"fb-instant-games",text:Editor.T("BUILDER.platforms.fb-instant-games")}),t.push({value:"wechatgame",text:Editor.T("BUILDER.platforms.wechatgame")}),t.push({value:"wechatgame-subcontext",text:Editor.T("BUILDER.platforms.wechatgame-subcontext")}),t.push({value:"baidugame",text:Editor.T("BUILDER.platforms.baidugame")}),t.push({value:"baidugame-subcontext",text:Editor.T("BUILDER.platforms.baidugame-subcontext")}),t.push({value:"qqplay",text:Editor.T("BUILDER.platforms.qqplay")}),t.push({value:"android",text:Editor.T("BUILDER.platforms.android")}),t.push({value:"android-instant",text:Editor.T("BUILDER.platforms.android-instant")}),"darwin"===process.platform&&(t.push({value:"ios",text:Editor.T("BUILDER.platforms.ios")}),t.push({value:"mac",text:Editor.T("BUILDER.platforms.mac")})),"win32"===process.platform&&t.push({value:"win32",text:Editor.T("BUILDER.platforms.win32")});let r=Editor.remote.Builder.simpleBuildTargets,a=[];for(let e in r){let t=r[e];t.settings&&a.push({value:t.platform,text:t.name})}return t=t.concat(a),w.map(e=>{if("string"==typeof e)return t.find(t=>t.value===e);{let r=e[Editor.lang];return t.find(e=>e.text.replace(/\s/g,"").toLowerCase()===r.replace(/\s/g,"").toLowerCase())}}).filter(Boolean)}(),scenes:[],all:!1,task:"",record:"",data:T,project:L,buildState:"idle",buildProgress:0,anysdk:"zh"===Editor.lang},computed:{actualPlatform:{get(){return this.data.actualPlatform},set(e){this.data.platform=this._actualPlatform2Platform(e),this.data.actualPlatform=e}},isNative(){return o[this.data.platform].isNative},needCompile(){var e=Editor.remote.Builder,t=e.simpleBuildTargets[this.data.actualPlatform];return t&&t.buttons?t.buttons.includes(e.DefaultButtons.Compile):o[this.data.platform].isNative}},watch:{data:{handler(e){this.saveLocalData()},deep:!0},project:{handler(e){B.save&&(D(e,B.data),B.save())},deep:!0},scenes:{handler(e){var t=this.project.startScene;for(let a=0;a<e.length;a++){let o=e[a];if(!o.text.startsWith("db://assets/resources/")&&t!==o.value){var r=this.project.excludeScenes.indexOf(o.value);o.checked||-1!==r?o.checked&&-1!==r&&this.project.excludeScenes.splice(r,1):this.project.excludeScenes.push(o.value)}}this.all=this.scenes.every(function(e){return e.checked})},deep:!0}},components:j,methods:{setSystemBarProgress(e){Editor.Ipc.sendToMain("builder:update-system-progress",e)},saveLocalData(){i.save&&(D(this.data,i.data),i.save())},t:e=>Editor.T(e),_actualPlatform2Platform(e){let t=Editor.remote.Builder.simpleBuildTargets[e];return t&&t.extends||e},_onOpenCompileLogFile(e){e.stopPropagation(),Editor.Ipc.sendToMain("app:open-cocos-console-log")},_onChooseDistPathClick(e){e.stopPropagation();let r=Editor.Dialog.openFile({defaultPath:l.getAbsoluteBuildPath(T.buildPath),properties:["openDirectory"]});r&&r[0]&&(t.contains(Editor.Project.path,r[0])?(this.data.buildPath=t.relative(Editor.Project.path,r[0]).replace(/\\/g,"/"),""===this.data.buildPath&&(this.data.buildPath="./")):this.data.buildPath=r[0])},_getAPILevel(e){let t=e.match("android-([0-9]+)$"),r=-1;return t&&(r=parseInt(t[1])),r},_onShowInFinderClick(t){t.stopPropagation();let a=l.getAbsoluteBuildPath(T.buildPath);if(!e.existsSync(a))return Editor.warn("%s not exists!",a),void 0;r.shell.showItemInFolder(a),r.shell.beep()},_onSelectAllCheckedChanged(e){if(!this.scenes)return;let t=this.project.startScene;for(let a=0;a<this.scenes.length;a++){let o=this.scenes[a];if(!o.text.startsWith("db://assets/resources/")&&t!==o.value){o.checked=e.detail.value;var r=this.project.excludeScenes.indexOf(o.value);o.checked||-1!==r?o.checked&&-1!==r&&this.project.excludeScenes.splice(r,1):this.project.excludeScenes.push(o.value)}}},startTask(e,t){this.task=e,Editor.Profile.load("profile://project/project.json",(r,a)=>{t.excludedModules=a.data["excluded-modules"],Editor.Ipc.sendToMain("builder:start-task",e,t)})},_onBuildClick(e){e.stopPropagation(),Editor.Ipc.sendToPanel("scene","scene:query-dirty-state",(e,t)=>{if(t.dirty)return Editor.error(t.name+" "+Editor.T("BUILDER.error.dirty_info")),void 0;this._build()})},async _build(){this.saveLocalData();var r=l.getAbsoluteBuildPath(T.buildPath),a=t.win32.dirname(r),d=T.platform;let n=o[d].isNative;if(Editor.isWin32&&n&&r.length>58)return k.showErrorBox(Editor.T("BUILDER.error.path_too_long_title"),Editor.T("BUILDER.error.path_too_long_desc",{max_length:58})),void 0;if(!e.existsSync(a))return k.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.build_dir_not_exists",{buildDir:a})),void 0;var u=this._getAPILevel(T.apiLevel);if("android"===d&&"binary"===T.template&&u<22)return k.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.binary_api_level")),void 0;if(-1!==r.indexOf(" "))return k.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.build_path_contains_space")),void 0;let c=B.data["android-instant"].recordPath||"";if(c=c.trim(),!("android-instant"!==d||this.project["android-instant"].skipRecord||c&&e.existsSync(t.join(c,"packageInfo.json"))))return k.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.refactor_info_not_found")),void 0;if(/.*[\u4e00-\u9fa5]+.*$/.test(r))return k.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.build_path_contains_chinese")),void 0;if(!("android"===d,/^[a-zA-Z0-9_-]*$/).test(this.project.title))return k.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.project_name_not_legal")),void 0;let p=this.project.packageName;if("ios"===d||"android"===d||"mac"===d){if(!("android"===d?/^[a-zA-Z0-9_.]*$/:/^[a-zA-Z0-9_.-]*$/).test(p))return k.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.package_name_not_legal")),void 0;let e=p.split(".");for(let t=0;t<e.length;t++)if(!isNaN(e[t][0]))return k.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.package_name_start_with_number")),void 0}let m=l.getOptions(B,i);if(m.wechatgame.separate_engine){let e=Editor.remote.Profile.load("profile://local/settings.json"),t=Editor.remote.Profile.load("profile://global/settings.json").data["use-default-js-engine"];!1===e.data["use-global-engine-setting"]&&(t=!0===e.data["use-default-js-engine"]);let r=Editor.remote.versions.CocosCreator;if(!t||!I.test(r))return k.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.separate_engine")),void 0}if("android"===d||"android-instant"===d){if(m.appABIs.find(e=>{if("arm64-v8a"===e)return e})&&parseInt(m.apiLevel.split("-")[1])<21)return k.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.arm64_not_support",{current_api:m.apiLevel,min_version:21})),void 0}if("android"===d&&u<26){let e=await x(Editor.Profile.load.bind(Editor.Profile))("profile://project/project.json");if(e&&e.data&&e.data.facebook&&e.data.facebook.enable)return k.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.facebook_min_compile_version",{version:26})),void 0}Editor.Ipc.sendToAll("builder:state-changed","ready",0);var h=this.scenes.filter(function(e){return e.checked}).map(function(e){return e.value});if(h.length>0){m.actualPlatform=this.data.actualPlatform,m.scenes=h;let e=m.platform;e&&(n&&"android-instant"!==e&&(m.inlineSpriteFrames=m.inlineSpriteFrames_native),m.embedWebDebugger=("web-mobile"===e||"fb-instant-games"===e)&&m.embedWebDebugger),this.startTask("build",m),Editor.Ipc.sendToMain("metrics:track-event",{category:"Project",action:"Build",label:m.actualPlatform||e}),s.trackModuleEvent()}else k.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.select_scenes_to_build"))},_onCompileClick(e){e.stopPropagation(),this.startTask("compile",l.getOptions(B,i))},_onStopCompileClick:function(e){e.stopPropagation(),Editor.Ipc.sendToMain("app:stop-compile")},_onPreviewClick(r){if(r.stopPropagation(),"android-instant"===T.platform&&!e.existsSync(t.join(Editor.globalProfile.data["android-sdk-root"],"extras/google/instantapps/ia")))return k.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.instant_utils_not_found")),void 0;var a=l.getOptions(B,i),o=Editor.remote.Builder.simpleBuildTargets[this.data.actualPlatform];if(o&&o.buttons){var s=o.buttons[1].message;Editor.Ipc.sendToMain(`${o.package}:${s}`,a)}else Editor.Ipc.sendToMain("app:run-project",a)},_openExternal(e,t){e.stopPropagation(),r.shell.openExternal(t)},_onRecordClick(e){let r=function(e){return["FullYear","Month","Date","Hours","Minutes","Seconds"].map(t=>{let r=e[`get${t}`]();return"Month"===t&&r++,r<10&&(r="0"+r),r}).join("")}(new Date),a=t.join(Editor.Project.path,`/temp/android-instant-games/profiles/${r}`);Editor.Ipc.sendToMain("app:play-on-device",{platform:"simulator",recordPath:a})},_onRefactorClick(e){Editor.Panel.open("google-instant-games")}}});U.project.title||(U.project.title=Editor.Project.name),U.project.xxteaKey||(U.project.xxteaKey=a.v4().substr(0,16)),U.project.packageName||(U.project.packageName="org.cocos2d."+U.project.title),U.data.buildPath||(U.data.buildPath="./build"),Editor.Ipc.sendToMain("builder:query-current-state",(e,t)=>{if(e)return Editor.warn(e);U.task=t.task,Editor.Ipc.sendToAll("builder:state-changed",t.state,t.progress)}),Editor.assetdb.queryAssets(null,"scene",function(e,t){var r=!1;r=r||function(e,t){for(var r=!1,a=0;a<e.length;a++){let o=e[a];t.some(e=>e.uuid===o)||(r=!0,e.splice(a--,1))}return r}(U.project.excludeScenes,t),function(e,t,r){if(1===t.length){let r=t[0];e.push({value:r.uuid,text:r.url,checked:!0})}else t.forEach(t=>{e.push({value:t.uuid,text:t.url,checked:-1===r.indexOf(t.uuid)})})}(U.scenes,t,U.project.excludeScenes),function(e,t){var r=e.startScene;let a=!!t.find(function(e){return e.value===r});r&&a||(t.length>0?e.startScene=t[0].value:e.startScene="")}(U.project,U.scenes),r&&U.project.save()})}});