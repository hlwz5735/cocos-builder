(function(){"use strict";const e=require("electron"),n=(require("fire-url"),require("fire-fs")),t=Editor.require("scene://edit-mode"),i=Editor.require("scene://lib/sandbox"),o=Editor.require("scene://utils/prefab"),r=Editor.require("scene://utils/animation"),s=Editor.require("scene://utils/scene"),c=Editor.require("scene://dump/hierarchy"),a=Editor.require("packages://scene/panel/tools/camera");function l(e){let n=Editor.assets[e];return n&&n.prototype.createNode}Editor.polymerPanel("scene",{behaviors:[Editor.UI.Droppable],hostAttributes:{droppable:"asset"},listeners:{"drop-area-enter":"_onDropAreaEnter","drop-area-leave":"_onDropAreaLeave","drop-area-accept":"_onDropAreaAccept","drop-area-move":"_onDropAreaMove","engine-ready":"_onEngineReady","scene-view-ready":"_onSceneViewReady","scene-view-init-error":"_onSceneViewInitError","panel-show":"_onPanelResize","panel-resize":"_onPanelResize","panel-copy":"_onPanelCopy","panel-paste":"_onPanelPaste","panel-unload":"_onPanelUnload"},properties:{selection:{type:Array,default:function(){return[]},observer:"_selectionChanged"},align:{type:Boolean,defaule:0,reflectToAttribute:!0},distribute:{type:Boolean,defaule:0,reflectToAttribute:!0}},created:function(){this._viewReady=!1,this._ipcList=[],this._copyingIds=null,this._pastingId="",this._ensureClose=!1,this._resetLayoutInfo=null,console.time("scene:reloading"),Editor.Ipc.sendToAll("scene:reloading")},run:function(e){if(!e||!e.uuid)return;this.confirmCloseScene(()=>{this._loadScene(e.uuid)})},ready:function(){this.selection=[],this.multi=!0,this._initDroppable(this.$.dropArea),_Scene.init(),Polymer.dom(this.$.border).insertBefore(_Scene.view,this.$.loader),this.$.sceneView=_Scene.view,this.$.sceneView.init(),e.ipcRenderer.on("editor:panel-undock",e=>{"scene"===e&&_Scene.EngineEvents.unregister()})},close:function(){if(!this._ensureClose){let n=e.ipcRenderer.sendSync("app:is-main-window-attemp-to-close");this.confirmCloseScene(()=>{this._clearSelection(),this._ensureClose=!0;var e=Editor.remote.Panel.findWindow("scene");n?e.nativeWin.close():this._resetLayoutInfo?Editor.Ipc.sendToMainWin("editor:reset-layout",this._resetLayoutInfo):e.nativeWin.reload()})}return!!this._ensureClose},_clearSelection:function(){Editor.Selection.clear("node"),_Scene.unselect(this.selection),this.selection=[]},_loadSceneScript:function(e,t){let i,o=Editor.url(t);if(!n.existsSync(o))return Editor.error(`Package [${e}] scene script [${t}] not exists.`),void 0;try{i=require(o)}catch(e){return Editor.error(e),void 0}this._sceneScripts[e]={path:o,messages:[]};for(let n in i){let t=i[n];if("function"!=typeof t)return Editor.warn(`[${n}] in package [${e}] is not a function.`),void 0;let o=`${e}:${n}`;this.messages[o]=t.bind(i),this._sceneScripts[e].messages.push(o)}},_unloadSceneScript:function(e){let n=this._sceneScripts[e].messages;for(let e=0;e<n.length;e++){let t=n[e];delete this.messages[t]}delete i.getElectronRequire().cache[this._sceneScripts[e].path],delete this._sceneScripts[e]},_loadSceneScripts:function(){this._sceneScripts={};for(let e in Editor.sceneScripts){let n=Editor.sceneScripts[e];this._loadSceneScript(e,n)}},_onPanelResize:function(){this._resizeDebounceID||(this._resizeDebounceID=setTimeout(()=>{this._resizeDebounceID=null,_Scene.view._resize()},10))},selectAll(e){e&&(e.stopPropagation(),e.preventDefault());let n=[];c.node().forEach(e=>{(function e(t){!t.locked&&n.push(t.id),t.children&&t.children.forEach(n=>{e(n)})})(e)}),Editor.Selection.select("node",n,!0,!1)},deleteCurrentSelected:function(e){e&&e.stopPropagation();let n=Editor.Selection.curSelection("node");s.deleteNodes(n)},duplicateCurrentSelected:function(e){e&&e.stopPropagation();let n=Editor.Selection.curSelection("node");s.duplicateNodes(n)},confirmCloseScene:function(e){o.confirmEditingPrefabSynced(),t.close(e)},_onPanelCopy:function(){let e=Editor.Selection.curSelection("node");s.copyNodes(e)},_onPanelPaste:function(){let e=Editor.Selection.curActivate("node");s.pasteNodes(e)},_onPanelUnload:function(){Editor.Ipc.sendToAll("scene:panel-unload")},_onDropAreaEnter:function(e){e.stopPropagation()},_onDropAreaLeave:function(e){e.stopPropagation()},_onDropAreaAccept:function(e){e.stopPropagation();let n=e.detail.dragOptions.unlinkPrefab,t=e.detail.dragItems.map(e=>e.id),i=e.detail.offsetX,o=e.detail.offsetY;s.createNodesAt(t,i,o,{unlinkPrefab:n})},_onDropAreaMove:function(e){if(r.STATE.RECORD||"asset"!==e.detail.dragType)return Editor.UI.DragDrop.updateDropEffect(e.detail.dataTransfer,"none"),void 0;let n="copy";for(let t of e.detail.dragItems){if("folder"===t.assetType||"skeleton-animation-clip"===t.assetType&&t.isSubAsset){n="none";break}if(!l(t.assetType)){if(!t.subAssetTypes||0===t.subAssetTypes.length){n="none";break}for(let e of t.subAssetTypes)if(!l(e)){n="none";break}}}Editor.UI.DragDrop.updateDropEffect(e.detail.dataTransfer,n)},_onEngineReady:function(){_Scene.EngineEvents.register()},_onSceneViewReady:function(){this._loadSceneScripts(),this._viewReady=!0,this.$.loader.hidden=!0,_Scene.Undo.clear(),Editor.Ipc.sendToAll("scene:ready"),console.timeEnd("scene:reloading")},_onSceneViewInitError:function(e){let n=e.detail;Editor.failed(`Failed to init scene: ${n.stack}`),this.$.loader.hidden=!0},_loadScene(e){_Scene.isLoadingScene=!0,Editor.Ipc.sendToAll("scene:reloading"),this.$.loader.hidden=!1,_Scene.loadSceneByUuid(e,e=>{if(_Scene.isLoadingScene=!1,e)return this.fire("scene-view-init-error",e),void 0;this.fire("scene-view-ready")})},_newScene(){this.$.loader.hidden=!1,Editor.Ipc.sendToAll("scene:reloading"),_Scene.newScene(()=>{this.fire("scene-view-ready"),_Scene._applyCanvasPreferences()})},_onAlignTop(){_Scene.alignSelection("top")},_onAlignVCenter(){_Scene.alignSelection("v-center")},_onAlignBottom(){_Scene.alignSelection("bottom")},_onAlignLeft(){_Scene.alignSelection("left")},_onAlignHCenter(){_Scene.alignSelection("h-center")},_onAlignRight(){_Scene.alignSelection("right")},_onDistributeTop(){_Scene.distributeSelection("top")},_onDistributeVCenter(){_Scene.distributeSelection("v-center")},_onDistributeBottom(){_Scene.distributeSelection("bottom")},_onDistributeLeft(){_Scene.distributeSelection("left")},_onDistributeHCenter(){_Scene.distributeSelection("h-center")},_onDistributeRight(){_Scene.distributeSelection("right")},messages:Editor.require("packages://scene/panel/messages"),_onZoomUp(){a.zoomUp()},_onZoomDown(){a.zoomDown()},_onZoomReset(){a.zoomReset()},_selectionChanged(){this.align=this.selection.length>1,this.distribute=this.selection.length>2}})})();