(function(){"use strict";const e=Editor.require("scene://edit-mode"),i=Editor.require("packages://scene/gizmo"),n=Editor.require("packages://scene/panel/tools"),t=Editor.require("app://editor/page/gizmos/utils/transform-tool-data"),o=Editor.require("packages://scene/panel/tools/camera"),c=Editor.require("scene://utils/scene");window.customElements.define("scene-gizmo",i);let s={listeners:{mousedown:"onMouseDown",mousewheel:"onMouseWheel",mousemove:"onMouseMove",mouseup:"onMouseUp",mouseleave:"onMouseLeave",keydown:"onKeyDown",keyup:"onKeyUp"},properties:{scale:{type:Number,value:1},mode:{type:String,value:"scene"}},_policy:null,ready:function(){this.$.editButtons.addEventListener("mousedown",e=>e.stopPropagation()),t.on("dimension-changed",this.onDimensionChanged.bind(this))},onDimensionChanged:function(e){this.$.helpText.innerHTML=e?this._T("SCENE.pan_hint"):this._T("SCENE.3d_transform_hint")},_T:function(e){return Editor.T(e)},detached:function(){clearInterval(this._initTimer)},init:function(){this.designSize=[0,0],this._initTimer=setInterval(()=>{let e=this.getBoundingClientRect();0===e.width&&0===e.height||(clearInterval(this._initTimer),cc.engine.isInitialized?(this.fire("engine-ready"),this.fire("scene-view-ready"),this._resize()):this._initEngine(()=>{this.$.gizmosView.sceneToPixel=this.sceneToPixel.bind(this),this.$.gizmosView.worldToPixel=this.worldToPixel.bind(this),this.$.gizmosView.pixelToScene=this.pixelToScene.bind(this),this.$.gizmosView.pixelToWorld=this.pixelToWorld.bind(this),this._resize()}))},100);var e=cc.ContainerStrategy.extend({apply:function(e,i){var n,t,o=e._frameSize.width,c=e._frameSize.height,s=cc.game.container.style,r=i.width,d=i.height,a=o/r,l=c/d;a<l?(n=o,t=d*a):(n=r*l,t=c),n=o-2*Math.round((o-n)/2),t=c-2*Math.round((c-t)/2),this._setupContainer(e,n,t),s.margin="0"}});this._policy=new cc.ResolutionPolicy(new e,cc.ContentStrategy.SHOW_ALL)},_initBuiltinNodes(){function e(e){let i=new cc.Node(e);return i.is3DNode=!0,i._objFlags|=cc.Object.Flags.DontSave|cc.Object.Flags.HideInHierarchy,i.groupIndex=cc.Node.BuiltinGroupIndex.DEBUG,cc.game.addPersistRootNode(i),i}this.foregroundNode=e("Editor Scene Foreground"),this.backgroundNode=e("Editor Scene Background"),this.foregroundNode.zIndex=cc.macro.MAX_ZINDEX,this.backgroundNode.zIndex=-cc.macro.MAX_ZINDEX},onSceneLaunched(){let e=cc.director.getScene();e.setScale(1),e.setPosition(0,0,0);for(let e=0;e<n.length;e++)n[e].onSceneLaunched&&n[e].onSceneLaunched()},_resize:function(){if(cc.engine.isInitialized&&cc.director.getScene()){let e=this.getBoundingClientRect();cc.view.setCanvasSize(e.width,e.height),cc.view.setDesignResolutionSize(e.width,e.height,_Scene.view._policy||cc.ResolutionPolicy.SHOW_ALL);for(let e=0;e<n.length;e++)n[e].onResize&&n[e].onResize()}},_hackSceneClass(){["_position","_eulerAngles","_scaleX","_scaleY","_scaleZ","_skewX","_skewY","scale","_name"].forEach(function(e){cc.Class.Attr.setClassAttr(cc.Scene,e,"serializable",!1)})},_initEngine:function(e){var i=this.$["engine-canvas"],t=this.getBoundingClientRect();i.width=t.width,i.height=t.height;var o=Editor.remote._projectProfile,c={id:"engine-canvas",width:t.width,height:t.height,designWidth:t.width,designHeight:t.height,groupList:o.data["group-list"],collisionMatrix:o.data["collision-matrix"]};_Scene._inited=!1,cc.engine.init(c,()=>{this.fire("engine-ready"),this._hackSceneClass(),this._initBuiltinNodes();for(let e=0;e<n.length;e++)n[e].init&&n[e].init();_Scene.initScene(i=>{if(_Scene._inited=!0,i)return this.fire("scene-view-init-error",i),void 0;this.fire("scene-view-ready"),cc.engine.emit("scene-view-ready"),e&&e()})})},sceneToPixel:function(e){return cc.v2(this.$.grid.valueToPixelH(e.x),this.$.grid.valueToPixelV(e.y))},worldToPixel:function(e){var i=cc.director.getScene();if(i){var n=i.convertToNodeSpaceAR(e);return this.sceneToPixel(n)}return this.sceneToPixel(e)},pixelToScene:function(e){return cc.v2(this.$.grid.pixelToValueH(e.x),this.$.grid.pixelToValueV(e.y))},pixelToWorld:function(e){var i=cc.director.getScene();return i?cc.v2(i.convertToWorldSpaceAR(this.pixelToScene(e))):this.pixelToScene(e)},_inEditMode:function(e){return"scene"!==e},_editModeIcon:function(e){return"scene"===e?"":Editor.url(`app://editor/builtin/scene/icon/${e}.png`)},_onSaveEditMode:function(){e.save()},_onCloseEditMode:function(){e.pop()},copyEditorCameraDataToNodes(){let e=o._camera.node,i=Editor.Selection.curSelection("node");c.copyNodeDataToNodes(e,i)}};["onMouseDown","onMouseWheel","onMouseMove","onMouseLeave","onMouseUp","onKeyDown","onKeyUp"].forEach(function(e){s[e]=function(i){if(i.stopPropagation(),cc.engine.isInitialized)for(let t=0;t<n.length&&(!n[t][e]||!n[t][e](i));t++);}}),Editor.polymerElement(s)})();