"use strict";const e=Editor.require("scene://edit-mode"),n=Editor.require("scene://utils/animation"),t=Editor.require("scene://utils/scene"),i=Editor.require("scene://dump/hierarchy"),r=require("../../../../share/engine-extends/object-walker"),l=require("lodash");module.exports={"query-dirty-state"(n){if(n.reply){let t=e.dirtyMode();if(t)return n.reply(null,{dirty:!0,name:t.name}),void 0;n.reply(null,{name:"scene",dirty:_Scene.Undo.dirty()})}},"query-group-list"(e){e.reply&&e.reply(null,cc.game.groupList)},"query-hierarchy"(e){if(!cc.engine.isInitialized)return e.reply(null,"",[]),void 0;let n=i.node(),t=_Scene.currentScene().uuid;e.reply(null,t,n)},"query-nodes-by-comp-name"(e,n){let t=cc.director.getScene(),i=[],r=cc.js.getClassByName(n);r&&_Scene.walk(t,!1,e=>{e.getComponent(r)&&i.push(e.uuid)}),e.reply(null,i)},"query-node"(e,n,t){if(e.reply){let t=_Scene.dumpNode(n);return t=JSON.stringify(t),e.reply(null,t),void 0}let i=_Scene.dumpNode(t);i=JSON.stringify(i),Editor.Ipc.sendToWins("scene:reply-query-node",n,i)},"query-node-info"(e,n,t){let i=null,r=cc.engine.getInstanceById(n);r&&(i=r instanceof cc.Component?r.node:r);let l=null;i&&"cc.Node"!==t&&(l=i.getComponent(cc.js._getClassById(t))),e.reply(null,{name:i?i.name:"",missed:null===r,nodeID:i?i.uuid:null,compID:l?l.uuid:null})},"query-node-functions"(e,n){var t=cc.engine.getInstanceById(n),i=Editor.getNodeFunctions(t);e.reply(null,i)},"choose-last-rigid-body"(e,n){var t=cc.engine.getInstanceById(n);if(t instanceof cc.Joint){var i=t.node.getSiblingIndex()-1;i<0&&(i=t.node.parent.children.length-1);var r=t.node.parent.children[i];if(!r)return;_Scene.Undo.recordNode(t.node.uuid),t.connectedBody=r.getComponent(cc.RigidBody),_Scene.Undo.commit()}},"choose-next-rigid-body"(e,n){var t=cc.engine.getInstanceById(n);if(t instanceof cc.Joint){var i=t.node.getSiblingIndex()+1;i>=t.node.parent.children.length&&(i=0);var r=t.node.parent.children[i];r||(r=t.node.parent),_Scene.Undo.recordNode(t.node.uuid),t.connectedBody=r.getComponent(cc.RigidBody),_Scene.Undo.commit()}},"is-child-class-of"(e,n,t){let i=cc.js._getClassById(n),r=cc.js._getClassById(t),l=cc.js.isChildClassOf(i,r);e.reply(null,l)},"has-copied-component":function(e){e.reply&&e.reply(null,t.hasCopiedComponent())},"query-animation-hierarchy"(e,n){let t=cc.engine.getInstanceById(n),r=t;for(;r&&!r.getComponent(cc.Animation);){if(r.parent instanceof cc.Scene){r=t;break}r=r.parent}e.reply&&e.reply(null,JSON.stringify(i.node(r,!0)))},"query-animation-list"(e,n){let t=cc.engine.getInstanceById(n);if(!t||t instanceof cc.Scene)return e.reply&&e.reply(null,[]),void 0;let i=t.getComponent(cc.Animation);if(!i)return e.reply&&e.reply(null,[]),void 0;let r=i.getClips(),l=(r=r.filter(function(e){return!!e})).map(e=>e._uuid);e.reply&&e.reply(null,l)},"query-animation-properties"(e,t){let i=cc.engine.getInstanceById(t),r=i;for(;r&&!r.getComponent(cc.Animation);){if(r.parent instanceof cc.Scene){r=i;break}r=r.parent}let l=Editor.getNodeDump(i),c=n.queryEditProperties(l,r!==i);e.reply&&e.reply(null,c)},"query-animation-record"(t){let i=e.curMode(),r=n.Cache.rNode,l=cc.engine.getInstanceById(n.Cache.component),c=l&&l.getAnimationState(n.Cache.animation).clip,o={record:i&&"animation"===i.name,root:r,clip:c?{id:c._uuid,name:c.name}:null};t.reply&&t.reply(null,o)},"query-animation-clip"(e,t){if(!n.curAnim)return e.reply&&e.reply(null,null);let i=n.curAnim.getClips();for(let n=0;n<i.length;n++){let r=i[n];if(r._uuid===t)return e.reply&&e.reply(null,Editor.serialize(r))}e.reply&&e.reply(null,null)},"query-asset-info"(e,n){e.reply&&Editor.assetdb.queryInfoByUuid(n,(...n)=>{e.reply(...n)})},"query-nodes-by-usedby-uuid"(e,n){let t=[];r.walk(cc.director.getScene(),(e,i,r,c)=>{if(r instanceof cc.Asset&&r._uuid===n){let e=l.findLast(c,e=>e instanceof cc.Node);e&&t.push(e.uuid)}}),e.reply(null,t)}};