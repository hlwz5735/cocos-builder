"use strict";const r=require("fire-fs"),e=require("path"),n=require("decompress"),o=require("./utils"),t=require("child_process").spawn;var i=function(r){return Editor.T(`store.package.${r}`)},s=e.join(Editor.remote.App.home,"download",".temp");r.removeSync(s);"darwin"===process.platform?exports.unzip=function(n,o,i){var s=e.dirname(o);r.ensureDirSync(s);var a=t("unzip",[n,"-d",o]),c="";a.stderr.on("data",r=>{c+=r});var d="";a.stdout.on("data",r=>{d+=r}),a.on("close",r=>{d&&console.log(d),c&&Editor.warn(c);var e=null;0!==r&&(e=new Error("The decompression has failed")),i(e)})}:"win32"===process.platform?exports.unzip=function(n,o,i){var s=e.dirname(o);r.ensureDirSync(s);var a=t(Editor.url("unpack://static/tools/unzip.exe"),[n,"-d",o]),c="";a.stderr.on("data",r=>{c+=r});var d="";a.stdout.on("data",r=>{d+=r}),a.on("close",r=>{d&&console.log(d),c&&Editor.warn(c);var e=null;0!==r&&(e=new Error("The decompression has failed")),i(e)})}:exports.unzip=function(r,e,o){n(r,e).then(function(){o()}).catch(function(r){o(r)})},exports.install=function(n,t,a){if(!r.existsSync(n))return a(new Error(i("exists_error")),!1);if(!/\.zip/.test(n))return a(new Error(i("type_error")),!1);Promise.resolve().then(function(){return new Promise((o,t)=>{var a=e.basename(n,".zip");a=e.join(s,a),exports.unzip(n,a,e=>{if(e)return r.remove(a,r=>{r&&Editor.warn(r)}),Editor.warn(e),t(new Error(i("unzip_error")));o({tmp:a})})})}).then(function(n){return new Promise((o,t)=>{(function(n,o){var t=r.readdirSync(n),s=e.join(n,"package.json");if(r.existsSync(s)){let e=r.readFileSync(s,"utf-8");o(null,n,JSON.parse(e))}else{let s;if(t.some(o=>{var t=e.join(n,o,"package.json");return!!r.existsSync(t)&&(s=t,!0)}),s){let n=r.readFileSync(s,"utf-8");o(null,e.dirname(s),JSON.parse(n))}else o(new Error(i("pkg_unknown")))}})(n.tmp,(e,s,a)=>{if(e)return r.remove(n.tmp,r=>{r&&Editor.warn(r)}),Editor.warn(e),t(new Error(i("package_error")));n.dir=s,n.json=a,o(n)})})}).then(function(e){return new Promise((n,o)=>{exports.check(e.json.name,(t,s)=>s?1===Editor.Dialog.messageBox({title:i("install"),message:`${name} ${i("exists")}`,buttons:[i("continue"),i("cancel")],defaultId:0,cancelId:1,noLink:!0})?(e.exists=!0,n(e)):(exports.unload(e.json.name,t=>(Editor.log(i("remove")),t?(r.remove(e.tmp,r=>{r&&Editor.warn(r)}),Editor.warn(t),o(i("error"))):(e.exists=!1,n(e)))),void 0):(e.exists=!1,n(e)))})}).then(function(n){return new Promise((s,a)=>{if(n.exists)return s(n);var c="";c="global"==t?Editor.remote.App.home:Editor.remote.Project.path;var d=e.join(c,"packages",n.json.name);o.copy(n.dir,d,e=>{if(e)return r.remove(n.tmp,r=>{r&&Editor.warn(r)}),o.remove(d,r=>{r&&Editor.warn(r)}),Editor.warn(e),a(new Error(i("install_error")));s(n)})})}).then(function(e){return new Promise((n,o)=>{r.remove(e.tmp,r=>{r&&Editor.warn(r),n(e)})})}).then(r=>{exports.load(r.dir,()=>{a(null,!r.exists)})}).catch(r=>{a(r,!1)})},exports.check=function(r,e){Editor.Ipc.sendToMain("store:check-package",r,(r,n)=>{e(null,!!n)})},exports.unload=function(r,e){Editor.Ipc.sendToMain("store:check-package",r,(r,n)=>{Editor.Ipc.sendToMain("store:unload-package",n,(r,t)=>{if(t)return e(t);setTimeout(()=>{o.remove(n,r=>{e(r)})},200)})})},exports.load=function(r,e){Editor.Ipc.sendToMain("store:load-package",r,(r,n)=>{e(n)})};