"use strict";const e=require("fs"),t=require("path"),o=require("../utils/cache"),i=require("../utils/operation"),s=require("../utils/event"),r=require("../utils/display"),n=require("../utils/communication");exports.template=e.readFileSync(t.join(__dirname,"../template/nodes.html"),"utf-8"),exports.props=["length"],exports.components={node:require("./node"),highlight:require("./highlight")},exports.data=function(){return{focused:!1,start:0,nodes:o.queryNodes(),list:[],uh:{height:0},y:-999,highlight:{node:null,state:0}}},exports.watch={start(){this.reset()},length(){this.reset()},nodes:{deep:!0,handler(){this.reset()}}},exports.methods={reset(){this._updateLock||(this._updateLock=!0,requestAnimationFrame(()=>{this._updateLock=!1,this.updateShowList()}))},updateShowList(){this.uh.height=0;for(let e=this.nodes.length-1;e>=0;e--){let t=this.nodes[e];if(-1!==t.showIndex){this.uh.height=20*t.showIndex+24;break}}let e=this.length;for(;this.list.length;)this.list.pop();for(let t=0;t<this.nodes.length;t++){let o=this.nodes[t];if(o.show&&o.showIndex>=this.start&&this.list.push(o),this.list.length>=e)break}},onMouseDown(e){if(Editor.Selection.setContext("node",null),2===e.button)return n.popup("node",{x:e.clientX,y:e.clientY}),void 0;Editor.Selection.select("node")},onScroll(e){let t=e.target.scrollTop;this.start=t/20|0},onFocus(){this.focused=!0},onBlur(){this.focused=!1},onDragStart(e){e.stopPropagation();let t=Editor.Selection.contexts("node");if(!t||t.length<=0)return e.preventDefault(),void 0;i.staging(t);let o=this.nodes.filter(e=>e.selected);Editor.UI.DragDrop.start(e.dataTransfer,{buildImage:!0,effect:"copyMove",type:"node",items:o.map(e=>({id:e.id,name:e.name}))})},onDragOver(e){e.stopPropagation()},onDragEnd(e){e.stopPropagation(),i.restore(),Editor.UI.DragDrop.end(),this.y=-999},onDropAreaMove(e){e.stopPropagation();let t=this.$el.getBoundingClientRect();this.y=this.$el.scrollTop+e.detail.clientY-t.top-5;let o=e.detail.dragType,i="none";"asset"===o?i="copy":"node"===o&&(i="move"),Editor.UI.DragDrop.updateDropEffect(e.detail.dataTransfer,i)},onDropAreaAccept(e){e.stopPropagation();let t=r.point(this.y),o=0,s=t.y%20;o=s<=5?1:s<=10?2:3,this.y=-999;let n=e.detail.dragItems.map(e=>e.id),a=t.node&&t.node.id;switch(e.detail.dragType){case"asset":i.prefab(n,a,o,{unlinkPrefab:e.detail.dragOptions.unlinkPrefab});break;case"node":i.move(n,a,o)}}},exports.directives={init(e,t){requestAnimationFrame(()=>{this.vm.reset()})}},exports.created=function(){s.on("refresh-node-tree",()=>{this.reset()}),s.on("nodes_focus",e=>{this.focused=e||!0,e&&this.$el&&this.$el.focus()})};