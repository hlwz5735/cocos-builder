"use strict";const e=require("electron"),t=require("fire-fs"),r=require("fire-path"),s=require("async"),i=require("fire-url"),a=require("./create-menu"),l=require("./search"),o=require("./sort"),n=require("../package.json");function d(){let e=Editor.Selection.contexts("asset");return e.length>0?e[0]:""}function c(e){let r=Editor.assetdb.loadMetaByUuid(e);if(!r)return Editor.info(e+" does not exists in library"),{};if(r.useRawfile())return Editor.info("This is a raw asset, it does not exists in library"),{};let s=r.dests(Editor.assetdb);return 0!==s.length&&t.existsSync(s[0])?{path:s[0],type:r.assetType()}:(Editor.failed("The asset %s is not exists in library",Editor.assetdb.uuidToUrl(e)),{})}function u(e,t,r){let s=a();s.forEach(t=>{t.params&&t.params.push(e)});let i=[{label:Editor.T("ASSETS.folder"),message:"assets:new-asset",params:[{name:"New Folder"},e]}];return i.push({type:"separator"}),i.concat(s)}module.exports={getContextTemplate:function(a,l,o,E){var p=[{label:Editor.T("ASSETS.create"),submenu:u(!0)},{type:"separator"},{label:Editor.T("ASSETS.copy"),enabled:!!E&&"mount"!==a,click(){let e=d();e&&Editor.Ipc.sendToPanel("assets","assets:copy",e)}},{label:Editor.T("ASSETS.paste"),enabled:!!E&&"mount"!==a,click(){let e=d();e&&Editor.Ipc.sendToPanel("assets","assets:paste",e)}},{type:"separator"},{label:Editor.T("ASSETS.rename"),enabled:"mount"!==a,click(){let e=d();e&&Editor.Ipc.sendToPanel(n.name,"assets:rename",e)}},{label:Editor.T("ASSETS.delete"),enabled:"mount"!==a,click(){let e=Editor.Selection.contexts("asset");e.length>0&&Editor.Ipc.sendToPanel(n.name,"assets:delete",e)}}];let S=Editor.assetdb.getAssetBackupPath(Editor.assetdb.uuidToFspath(o));return S&&t.existsSync(S)&&!function(e){let t=Editor.assetdb.uuidToUrl(e);try{let e=t.split(r.sep);return 3===e.length.length||4===e.length&&""===e[3]}catch(e){return!1}}(o)&&p.push({label:Editor.T("ASSETS.rollback"),click(){let e=Editor.assetdb.uuidToUrl(o);1===Editor.Dialog.messageBox({type:"warning",buttons:["Cancel","OK"],title:"Rollback Asset",message:Editor.T("ASSETS.sure_rollback",{url:e}),defaultId:0,cancelId:0,noLink:!0})&&s.waterfall([function(r){t.readFile(S,(t,s)=>{if(t)return r(t);Editor.assetdb.saveExists(e,s,t=>{if(t)return Editor.error(`Rollback ${e} failed: ${t.stack}`),void 0;Editor.Dialog.messageBox({type:"warning",buttons:["OK"],title:"Rollback Asset",message:Editor.T("ASSETS.rollback_tip",{url:e}),defaultId:0,cancelId:0,noLink:!0})})})}],function(e){e&&Editor.warn(Editor.T("ERROR.assets.rollback"))})}}),p=p.concat([{type:"separator"},{label:Editor.T("ASSETS.find_usages"),enabled:"mount"!==a,click(){let e=d();e&&Editor.Ipc.sendToPanel(n.name,"assets:find-usages",e)}},{label:Editor.isDarwin?Editor.T("ASSETS.reveal_mac"):Editor.T("ASSETS.reveal_win"),click(){let r=d();if(r){let s=Editor.assetdb.uuidToFspath(r);t.existsSync(s)?e.shell.showItemInFolder(s):Editor.failed("Can not found the asset %s",Editor.assetdb.uuidToUrl(r))}}},{type:"separator"},{label:Editor.T("ASSETS.open_in_library"),click(){let e=d();if(e){let{path:t}=c(e);t&&Editor.Ipc.sendToMain("assets:open-text-file-by-path",t)}}},{label:Editor.T("ASSETS.reveal_library"),click(){let t=d();if(t){let{path:r}=c(t);r&&e.shell.showItemInFolder(r)}}},{label:Editor.T("ASSETS.reveal_hierarchy"),visible:"javascript"===a||"coffeescript"===a||"typescript"===a,click(){let e=d();if(e){let t=Editor.assetdb.uuidToUrl(e);Editor.Ipc.sendToPanel("hierarchy","filter",`t:${i.basenameNoExt(t)}`)}}},{label:Editor.T("ASSETS.show_uuid"),click(){let e=d();if(e){let t=Editor.assetdb.uuidToUrl(e),r=Editor.Utils.UuidUtils.compressUuid(e,!0);Editor.info(`${e} (${r}), ${t}`)}}}])},getCreateTemplate:u,getSearchTemplate:function(){return l()},getSortTemplate:function(){return o()}};