"use strict";const e=require("fire-url"),t=require("./cache"),r=require("./event");exports.loadAssets=function(){r.emit("start-loading"),Editor.assetdb.deepQuery((e,o)=>{try{if(console.time("assets-tree._build()"),e)return console.error("load assets error ",e),void 0;let r=t.genAssetsTree(o);this.fold(r.children[0].id,!1),console.timeEnd("assets-tree._build()")}catch(e){Editor.warn(e.message)}r.emit("finish-loading"),r.emit("assets-tree-ready")})},exports.show=function(e,r){let o=t.queryNode(e);return!!o&&(o.show=r,this.updateShowNodes(),!0)},exports.select=function(e,r){let o=t.queryNode(e);o&&(o.selected=r)},exports.rename=function(e){let r=t.queryCache();for(let t in r){let o=r[t];o.rename=o.id===e&&!o.readonly&&!o.isMount}},exports.fold=function(e,r){let o=t.queryCache()[e];if(!o)return console.log("can't find node ",e),!1;o.fold=r,o.children&&o.children.forEach(e=>{(function e(t){t.show=!r,r?t.children.forEach(t=>{e(t)}):r===t.fold&&t.children.forEach(t=>{e(t)})})(e)}),this.updateShowNodes()},exports.recFoldNodes=function(e,r){let o=t.queryNode(e);if(!o)return!1;o.children&&o.children.forEach(e=>{this.fold(e.id,r),this.recFoldNodes(e.id,r)})},exports.recParentNodes=function(e,r){let o=t.queryNode(e);if(!o)return;let n=e=>{let o=t.queryNode(e.parent);o&&(o!==t.queryRoot()&&this.fold(o.id,r),o.parent&&n(o))};n(o)},exports.updateShowNodes=function(){let e=t.queryRoot(),r=[],o=function(e){e.show&&e.children&&e.children.forEach(e=>{e.show&&(r.push(e),o(e))})};o(e),t.updateShowNodes(r)},exports.getRealUrl=function(r,o){let n=t.queryCache(),i=(t.queryRoot(),n[r]);if(!i)return null;let d=(o||i.name)+i.extname,s=n[i.parent];for(;s;)d=e.join(s.name+s.extname,d),s=n[s.parent];return d="db://"+d},exports.getPath=function(r){let o=t.queryCache(),n=o[r];if(!n)return null;let i="",d=o[n.parent];for(;d;)i=e.join(d.name+d.extname,i),d=o[d.parent];return i="db://"+i},exports.move=function(e,r,o){let n=t.queryNode(e);n.name=o||n.name;let i=t.queryNode(r);if(!i)return;let d=t.queryNode(n.parent),s=d.children.indexOf(n);s>-1&&d.children.splice(s,1),i.children.push(n),n.parent=r,n.level=i.level+1,n.children.forEach(e=>{e.level=n.level+1}),i.children.sort(t.sortChildrenNodes),this.fold(i.id,!1)},exports.updateUuid=function(e,r){let o=t.queryNode(e),n=t.queryCache();o.id=r,delete n[e],n[r]=o},exports.updateIcon=function(e){let r=t.queryNode(e);if(!r)return;r.iconUrl=null;let o=t.queryNode(r.parent);o&&(o.iconUrl=null)},exports.hint=function(e){let r=t.queryNode(e);if(!r||r.hint)return!1;r.hint=!0,setTimeout(()=>{r.hint=!1},800)},exports.remove=function(e){t.remove(e)&&this.updateShowNodes()},exports.add=function(e){t.add(e),this.updateShowNodes()},exports.autoSort=function(){t.sortAssetsTree(),this.updateShowNodes()};let o=[];exports.staging=function(e){let r=t.queryNodes();o.length=0,r.forEach(t=>{t.selected&&o.push(t.id),t.selected=-1!==e.indexOf(t.id)})},exports.restore=function(){let e=[];return t.queryNodes().forEach(t=>{t.selected&&e.push(t.id),t.selected=-1!==o.indexOf(t.id)}),o=[],e};