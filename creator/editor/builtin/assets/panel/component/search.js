"use strict";const t=require("fs"),e=require("fire-path"),i=require("async"),s=require("../utils/cache"),r=require("../utils/operation"),h=require("../utils/event"),o=require("../utils/utils");exports.template=t.readFileSync(e.join(__dirname,"../template/search.html"),"utf-8"),exports.components={node:require("./node")},exports.props=["filter","length"],exports.data=function(){return{nodes:s.queryNodes(),filterNodes:[],type:null,text:"",uuids:[],uh:{height:0},showList:[],start:0}},exports.watch={start(){this.reset()},length(){this.reset()},filterNodes(){this.reset()},nodes(){this.filter&&o.emptyFilter()},filter(){let t=this.filter;if(!t)return;let s=[],o="",l="",n=t.split(" ");t="";for(let e=0,i=n.length;e<i;e++){let i=n[e];if(i)if(/^t:.*/.test(i)){let t=i.substring(2).split(",").map(t=>t.trim());s=s.concat(t)}else/^u:.*/.test(i)?o=i.substring(2):/^used:.*/.test(i)?l=i.substring(5):t=i}clearTimeout(this._searchID),h.emit("start-loading",100),this.uuids=[],this._searchID=null;let u=setTimeout(()=>{h.emit("finish-loading"),u===this._searchID&&Editor.assetdb.queryAssets(null,s,(s,h)=>{if(u!==this._searchID)return;this.text=t.toLowerCase(),o=o.toLowerCase(),l=l.toLowerCase();i.waterfall([t=>{if(!l||!Editor.Utils.UuidUtils.isUuid(l))return t(),void 0;Editor.assetdb.queryInfoByUuid(l,(e,i)=>{if(e)return t(),void 0;i&&this.isScript(i.type)&&(l=Editor.Utils.UuidUtils.compressUuid(l)),t()})},t=>{h.forEach(t=>{if(t.hidden)return;let i=e.basenameNoExt(t.path);e.extname(t.path);this.validate(i,this.text)&&this.validate(t.uuid,o)&&this.findUsages(t,l)&&this.uuids.push(t.uuid)}),t()},t=>{this.filterNodes=this.nodes.filter(t=>{if(this.uuids&&-1===this.uuids.indexOf(t.id))return!1;if(this.text){let e=t.name.toLowerCase();if(this.text=this.text.toLowerCase(),-1===e.indexOf(this.text))return!1}return!0}),t()}],()=>{Editor.Selection.curSelection("asset").forEach(t=>{r.select(t,!0)})})})},200);this._searchID=u}},exports.methods={isScript:t=>"javascript"===t||"coffeescript"===t||"typescript"===t,reset(){this._updateLock||(this._updateLock=!0,requestAnimationFrame(()=>{this._updateLock=!1,this.showNodeFilter()}))},showNodeFilter:function(){this.uh.height=0,this.showList=[];let t=this.filterNodes,e=this.start+Math.ceil(this.length);e=e>t.length?t.length:e;for(let i=this.start;i<e;i++)this.showList.push(t[i]);this.uh.height=t.length*s.lineHeight+4},scrollIfNeeded(t){let e=s.queryNode(t);if(!e)return;let i=this.filterNodes.indexOf(e);if(-1===i)return;let r=i*s.lineHeight,h=this.$el.scrollTop+this.$el.clientHeight-s.lineHeight-2;r<this.$el.scrollTop-2?this.$el.scrollTop-=this.$el.scrollTop-2-r:r>=h&&(this.$el.scrollTop+=r-h)},validate:(t,e)=>t.toLowerCase().indexOf(e.toLowerCase())>-1,addShowList(t){-1===this.showList.indexOf(t)&&this.showList.push(t)},removeShowList(t){let e=this.showList.indexOf(t);-1!==e&&this.showList.splice(e,1)},findUsages(e,i){if(!i)return!0;if(i===e.uuid)return!1;if(!e.destPath)return!1;return t.readFileSync(e.destPath).indexOf(i)>=0},onUpdateFilter(t,e){if(this.uuids&&-1===this.uuids.indexOf(t.id))return!1;if(e){let i=t.name.toLowerCase();e=e.toLowerCase();let s=-1!==i.indexOf(e);return s?this.addShowList(t):this.removeShowList(t),s}return this.addShowList(t),!0},onScroll(t){let e=t.target.scrollTop;this.start=e/s.lineHeight|0},onDragStart:o.onDragStart,onDragOver:o.onDragOver,onDragEnd:o.onDragEnd};