"use strict";const e=require("fire-fs"),r=require("path"),t=require("events");let o=require("./icon"),a=require("./prefab"),n=null;exports.event=new t.EventEmitter,exports.event.setMaxListeners(100),exports.set=function(e){let r=e.local.data;r.user&&r.user.classify&&!r.user.prefab?(delete r.classify,delete r.title,delete r.modify,e.local.save(),exports.event.emit("profile-save")):r.user||(r.user={name:"User",prefab:[]},e.local.save(),exports.event.emit("profile-save")),n=e},exports.get=function(){return n},exports.queryZoom=function(){return n.global.data.prefabZoom||1},exports.setZoom=function(e){n.global.data.prefabZoom=e,n.global.save(),exports.event.emit("profile-save")},exports.queryList=function(e){return 1===e&&n.local.data.user?[n.local.data.user]:a.query(e)},exports.setIcon=function(t,o){if(!e.existsSync(o))return!1;if(e.statSync(o).size>20480)return Editor.warn(Editor.T("node-library.warning.icon_size")),!1;let a=r.join(Editor.Project.path,"temp","node-library-icon");e.ensureDirSync(a);let n=r.join(a,`${t}.png`);e.copySync(o,n),exports.event.emit("prefab-icon-changed",t)},exports.deleteIcon=function(t){let o=r.join(Editor.Project.path,"temp","node-library-icon",`${t}.png`);e.existsSync(o)&&e.removeSync(o),exports.event.emit("prefab-icon-changed",t)},exports.queryIcon=function(t){let a=o[t];if(!a){let n=r.join(Editor.Project.path,"temp","node-library-icon",`${t}.png`);a=e.existsSync(n)?n:o.default}return a},exports.pushUserPrefab=function(e){Editor.assetdb.queryInfoByUuid(e,(t,o)=>{let a=r.basename(o.path).replace(/\.([^\.]+)$/,""),s=n.local.data.user||{name:"User",prefab:[]};if(s.prefab.some(r=>r.uuid===e))return Editor.warn(Editor.T("node-library.warning.prefab_exists"));s.prefab.push({name:a,uuid:e}),n.local.data.user=s,n.local.save(),exports.event.emit("profile-save")})},exports.deleteUserPrefab=function(e){let r=n.local.data.user;r&&r.prefab&&r.prefab.some((t,o)=>t.uuid===e&&(r.prefab.splice(o,1),n.local.save(),exports.event.emit("profile-save"),!0))},exports.renameUserPrefab=function(e,r){let t=n.local.data.user;t&&t.prefab&&t.prefab.some((t,o)=>t.uuid===e&&(t.name=r,n.local.save(),exports.event.emit("profile-save"),!0))};