const e=require("path"),n=require("fs"),i=require("gulp"),r=(require("gulp-sourcemaps"),require("babelify")),t=require("browserify"),s=require("vinyl-source-stream"),o=(require("gulp-uglify"),require("vinyl-buffer"));require("async");function u(i,r){if(!n.existsSync(r))return!0;let t=n.statSync(r);return function i(r,t){return n.readdirSync(r).some(s=>{let o=e.join(r,s),u=n.statSync(o);return u.isDirectory()?i(o,t):u.mtime.getTime()>t||void 0})}(e.dirname(i),t.mtime.getTime())}function a(n,u,a){let d=e.basename(u);u=e.dirname(u);let l=t(n);return a&&a.forEach(function(e){l.exclude(e)}),l.transform(r,{presets:["env"]}).bundle().pipe(s(d)).pipe(o()).pipe(i.dest(u))}function d(e,n){return i.src(e).pipe(i.dest(n))}const l={prebuild:async function(n){let{rootPath:i,dstPath:r}=n;if(!i)throw new Error("Please specify the jsbAdapter path");console.time("build jsb-adapter"),await new Promise(n=>{let t=e.join(i,"./builtin/index.js"),s=e.join(r,"./jsb-builtin.js");u(t,s)?a(t,s).on("end",n):n()}),await new Promise(n=>{let t=e.join(i,"./engine/index.js"),s=e.join(r,"./jsb-engine.js");u(t,s)?a(t,s).on("end",n):n()}),console.timeEnd("build jsb-adapter")},build:async function(n){let{rootPath:i,dstPath:r,excludedModules:t}=n;if(!i)throw new Error("Please specify the jsbAdapter path");console.time("build jsb-adapter"),await new Promise(n=>{d(e.join(i,"./bin/jsb-builtin.js"),r).on("end",n)}),await new Promise(n=>{if(t&&t.length>0){let s=[],o=require(Editor.url("packages://jsb-adapter/modules.json"));t.forEach(function(n){o.some(function(r){if(r.name===n&&r.entries)return r.entries.forEach(function(n){s.push(e.join(i,n))}),!0})}),a(e.join(i,"./engine/index.js"),e.join(r,"./jsb-engine.js"),s).on("end",n)}else d(e.join(i,"./bin/jsb-engine.js"),r).on("end",n)}),console.timeEnd("build jsb-adapter")}};module.exports=l;