"use strict";const e=require("fire-fs"),{promisify:t}=require("util"),{gltfAttribMap:s,gltfTopology:i,type2size:r,compType2Array:n}=require("./utils/gltf");module.exports=class extends Editor.metas.asset{constructor(e){super(e),this.verts=0,this.tris=0,this.submeshes=0,this.minPos=cc.v3(),this.maxPos=cc.v3(),this._vertexBundles=[],this._primitives=[],this._buffer=[]}static version(){return"1.0.1"}static defaultType(){return"mesh"}import(e,t){if(this._assetdb.isSubAssetByPath(e))return t();t()}async importGltf(e,t,s){const i=e.meshes[s],r=e.accessors,n=e.bufferViews;let o=[],f=0,u=0,h=i.primitives,a=cc.v3(1/0,1/0,1/0),c=cc.v3(-1/0,-1/0,-1/0);for(let e=0;e<h.length;e++){let s=h[e];if(void 0===s.indices)continue;const l=r[s.attributes.POSITION];if(l){f+=l.count;let e=l.min,t=l.max;a.x=Math.min(a.x,e[0]),a.y=Math.min(a.y,e[1]),a.z=Math.min(a.z,e[2]),c.x=Math.max(c.x,t[0]),c.y=Math.max(c.y,t[1]),c.z=Math.max(c.z,t[2]),u+=r[s.indices].count}this.generateVBBuffer(r,t,o,n,s.attributes),this.generateIBBuffer(r,t,o,n,s,e,i.name)}this.verts=f,this.tris=u/3,this.submeshes=h.length,this.minPos=a,this.maxPos=c,this._buffer=new Buffer(new Uint8Array(o)),await this.save()}generateVBBuffer(e,t,i,n,o){const{VertexBundle:f,BufferRange:u,VertexFormat:h}=Editor.require("unpack://engine-dev/cocos2d/core/mesh/mesh-data");let a=new u;a.offset=i.length;let c=[],l=[],m=1/0;for(let i in o){const f=s[i];if(void 0===f){Editor.error(`Found unacceptable GlTf attribute ${i}.`);continue}let u=e[o[i]];m=Math.min(u.count,m);let a=n[u.bufferView],d=new h;d.name=f,d.type=u.componentType,d.num=r[u.type],l.push(d),a.byteLength,u.count,c.push({byteLength:a.byteLength,byteOffset:a.byteOffset,perByte:a.byteStride||a.byteLength/u.count,buffer:t[a.buffer]})}for(let e=0;e<m;e++)for(let t=0;t<c.length;t++){let s=c[t],r=s.buffer,n=s.perByte,o=s.byteOffset+e*n;for(let e=0;e<n;e++)i.push(r[o+e])}a.length=i.length-a.offset;let d=new f;d.verticesCount=m,d.formats=l,d.data=a,this._vertexBundles.push(d)}generateIBBuffer(e,t,s,r,o,f,u){const{BufferRange:h,Primitive:a}=Editor.require("unpack://engine-dev/cocos2d/core/mesh/mesh-data");let c=e[o.indices],l=r[c.bufferView],m=t[l.buffer],d=new h;d.offset=s.length;let b=c.componentType;if(b>=5124&&b<=5126){Editor.warn(`Mesh [name:${u}, uuid: ${this.uuid}] IndexBuffer type is [${n[b]}], which is not support in Webgl1.`);let e=new n[b](m.buffer,l.byteOffset,c.count),t=new Uint16Array(c.count);for(let s=0;s<t.length;s++)t[s]=e[s]>65535?0:e[s];let i=new Uint8Array(t.buffer,0,t.byteLength);for(let e=0;e<t.byteLength;e++)s.push(i[e]);b=5123}else for(let e=l.byteOffset,t=l.byteOffset+l.byteLength;e<t;e++)s.push(m[e]);d.length=s.length-d.offset;let p=new a;p.vertexBundleIndices=[f],p.data=d,p.indexUnit=b,p.topology=i[o.mode],this._primitives.push(p)}async save(){let s=new(Editor.require("unpack://engine-dev/cocos2d/core/mesh/CCMesh"));s._minPos=this.minPos,s._maxPos=this.maxPos,s._primitives=this._primitives,s._vertexBundles=this._vertexBundles,s._setRawAsset(".bin"),this._assetdb.saveAssetToLibrary(this.uuid,s);let i=this._assetdb._uuidToImportPathNoExt(this.uuid)+".bin";await t(e.writeFile)(i,this._buffer)}};