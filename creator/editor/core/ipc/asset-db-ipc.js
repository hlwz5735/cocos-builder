"use strict";const e=require("electron"),t=e.ipcMain,s=require("path");require("fire-fs");t.on("asset-db:explore",(t,s)=>{var i=Editor.assetdb._fspath(s);e.shell.showItemInFolder(i)}),t.on("asset-db:query-path-by-url",(e,t)=>{e.reply&&e.reply(null,Editor.assetdb._fspath(t))}),t.on("asset-db:query-uuid-by-url",(e,t)=>{e.reply&&e.reply(null,Editor.assetdb.urlToUuid(t))}),t.on("asset-db:query-path-by-uuid",(e,t)=>{e.reply&&e.reply(null,Editor.assetdb.uuidToFspath(t))}),t.on("asset-db:query-url-by-uuid",(e,t)=>{e.reply&&e.reply(null,Editor.assetdb.uuidToUrl(t))}),t.on("asset-db:query-info-by-uuid",(e,t)=>{e.reply&&e.reply(null,Editor.assetdb.assetInfoByUuid(t))}),t.on("asset-db:query-meta-info-by-uuid",(e,t)=>{if(!e.reply)return;let i=Editor.assetdb.uuidToFspath(t);if(i){let r=i+".meta",d=Editor.require("app://asset-db/lib/meta").get(Editor.assetdb,t),a=JSON.stringify(d.serialize(),null,2),o=Editor.assetdb.isSubAssetByPath(i),u=Editor.assetdb._uuid2mtime[t];if(o){let e=Editor.assetdb.fspathToUuid(s.dirname(i));u=Editor.assetdb._uuid2mtime[e]}return e.reply(null,{assetType:d.assetType(),defaultType:d.constructor.defaultType(),assetUrl:Editor.assetdb.uuidToUrl(t),assetPath:i,metaPath:r,metaMtime:u?u.meta:0,assetMtime:u?u.asset:0,isSubMeta:o,json:a}),void 0}e.reply()}),t.on("asset-db:deep-query",e=>{e.reply&&Editor.assetdb.deepQuery((t,s)=>{e.reply(null,s)})}),t.on("asset-db:query-assets",(e,t,s)=>{e.reply&&Editor.assetdb.queryAssets(t,s,(t,s)=>{e.reply(null,s)})}),t.on("asset-db:query-mounts",e=>{e.reply&&e.reply(null,Editor.assetdb._mounts)}),t.on("asset-db:import-assets",(e,t,s,i)=>{i&&Editor.Ipc.sendToPanel("assets","assets:start-refresh"),Editor.assetdb.watchOFF(),Editor.assetdb.import(t,s,(t,s)=>{e.reply&&(t?e.reply():e.reply(null,s)),i&&Editor.Ipc.sendToPanel("assets","assets:end-refresh")}),Editor.App.focused||Editor.assetdb.watchON()}),t.on("asset-db:create-asset",(e,t,s)=>{Editor.assetdb.watchOFF(),Editor.assetdb.create(t,s,e.reply&&function(t,s){e.reply(t,s)}),Editor.App.focused||Editor.assetdb.watchON()}),t.on("asset-db:move-asset",(e,t,s,i)=>{Editor.assetdb.watchOFF(),Editor.assetdb.move(t,s,(r,d)=>{r&&(i?Editor.Dialog.messageBox({type:"warning",buttons:[Editor.T("MESSAGE.ok")],title:Editor.T("MESSAGE.warning"),message:Editor.T("MESSAGE.assets.failed_to_move",{srcUrl:t,destUrl:s}),detail:`${r.message}`,noLink:!0}):Editor.assetdb.error(Editor.T("MESSAGE.assets.failed_to_move",{srcUrl:t,destUrl:s})+`messages: ${r.stack}`)),e.reply&&e.reply(r,d)}),Editor.App.focused||Editor.assetdb.watchON()}),t.on("asset-db:delete-assets",(e,t)=>{Editor.assetdb.watchOFF(),Editor.assetdb.delete(t,e.reply&&function(t,s){e.reply(t,s)}),Editor.App.focused||Editor.assetdb.watchON()}),t.on("asset-db:save-exists",(e,t,s)=>{Editor.assetdb.watchOFF(),Editor.assetdb.saveExists(t,s,e.reply&&function(t,s){e.reply(t,s)}),Editor.App.focused||Editor.assetdb.watchON()}),t.on("asset-db:create-or-save",(e,t,s)=>{Editor.assetdb.watchOFF(),Editor.assetdb.exists(t)?Editor.assetdb.saveExists(t,s,e.reply&&function(t,s){e.reply(t,s)}):Editor.assetdb.create(t,s,e.reply&&function(t,s){e.reply(t,s)}),Editor.App.focused||Editor.assetdb.watchON()}),t.on("asset-db:save-meta",(e,t,s)=>{Editor.assetdb.watchOFF(),Editor.assetdb.saveMeta(t,s,e.reply&&function(){e.reply()}),Editor.App.focused||Editor.assetdb.watchON()}),t.on("asset-db:refresh",(e,t)=>{Editor.assetdb.watchOFF(),Editor.assetdb.refresh(t,e.reply&&function(t,s){e.reply(t,s)}),Editor.focused||Editor.assetdb.watchON()}),t.on("asset-db:attach-mountpath",(e,t)=>{Editor.assetdb.watchOFF(),Editor.assetdb.attachMountPath(t,e.reply&&function(t){e.reply(t)}),Editor.focused||Editor.assetdb.watchON()}),t.on("asset-db:unattach-mountpath",(e,t)=>{Editor.assetdb.watchOFF(),Editor.assetdb.unattachMountPath(t,e.reply&&function(t){e.reply(t)}),Editor.focused||Editor.assetdb.watchON()}),t.on("asset-db:query-watch-state",()=>{Editor.Ipc.sendToMainWin("asset-db:watch-state-changed",Editor.assetdb.getWatchState())}),t.on("asset-db:asset-changed",function(e,t){if(Editor.QuickCompiler.isScript(t.type)){var s=Editor.assetdb.uuidToFspath(t.uuid);Editor.QuickCompiler.moveScripts([s],[t.uuid])}}),t.on("asset-db:asset-uuid-changed",function(e,t){Editor.QuickCompiler.needCompile(t.type,t.uuid)&&Editor.QuickCompiler.scriptUuidChanged(t.oldUuid,t.uuid)}),t.on("asset-db:assets-moved",function(e,t){var s=!1,i=!1,r=[],d=[];t.forEach(function(e){Editor.QuickCompiler.needCompile(e.type,e.uuid)&&(d.push(e.uuid),r.push(e.srcPath),s=!0),!s&&Editor.QuickCompiler.isScript(e.type)&&(i=!0),"scene"===e.type&&e.uuid===Editor.currentSceneUuid&&Editor.Ipc.sendToMain("scene:update-title")}),s?Editor.QuickCompiler.moveScripts(r,d):i&&Editor.QuickCompiler.reloadScripts()}),t.on("asset-db:assets-created",function(e,t){var s=!1,i=!1,r=[];t.forEach(function(e){Editor.QuickCompiler.needCompile(e.type,e.uuid)&&(r.push(e.uuid),s=!0),!s&&Editor.QuickCompiler.isScript(e.type)&&(i=!0),"scene"===e.type&&(Editor.sceneList.push(e.uuid),e.uuid===Editor.currentSceneUuid&&Editor.Ipc.sendToMain("scene:update-title"))}),s?Editor.QuickCompiler.compileScripts(r):i&&Editor.QuickCompiler.reloadScripts()}),t.on("asset-db:assets-deleted",function(e,t){var s=!1,i=!1,r=[],d=[];t.forEach(function(e){if(Editor.QuickCompiler.needCompile(e.type,e.uuid)&&(r.push(e.path),d.push(e.uuid),s=!0),!s&&Editor.QuickCompiler.isScript(e.type)&&(i=!0),"scene"===e.type){var t=Editor.sceneList.indexOf(e.uuid);-1!==t&&Editor.sceneList.splice(t,1),e.uuid===Editor.currentSceneUuid&&(Editor.Ipc.sendToMain("scene:set-current-scene",null,()=>{}),Editor.Ipc.sendToMain("scene:update-title"))}}),s?Editor.QuickCompiler.removeScripts(r,d):i&&Editor.QuickCompiler.reloadScripts()}),t.on("asset-db:script-import-failed",function(e,t){t.error&&Editor.QuickCompiler.singleScriptCompileFailed(t)}),t.on("asset-db:meta-backup",(t,i)=>{if(!Editor.App._profile.data["show-meta-backup-dialog"])return;let r=s.normalize(s.join(Editor.Project.path,Editor.metaBackupPath)),d=Editor.T("MESSAGE.assets.meta_backup_detail",{backupPath:r});i.forEach((e,t)=>{d+="\n"+(t+1)+". "+e});let a=Editor.Dialog.messageBox({type:"warning",buttons:[Editor.T("MESSAGE.ok"),Editor.T("MESSAGE.assets.meta_backup_help"),Editor.T("MESSAGE.assets.meta_backup_never_show")],message:Editor.T("MESSAGE.assets.meta_backup_msg"),detail:d,noLink:!0,defaultId:0});1===a?e.shell.openExternal(Editor.T("MESSAGE.assets.meta_backup_help_url")):2===a&&(Editor.App._profile.data["show-meta-backup-dialog"]=!1,Editor.App._profile.save())});