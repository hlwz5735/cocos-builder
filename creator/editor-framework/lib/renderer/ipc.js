"use strict";let e={};module.exports=e;const n=require("electron"),r=require("../share/ipc"),t=require("./console"),i=require("./panel"),o=n.ipcRenderer,s=n.remote.getCurrentWindow().id;let l=1e3,a={},d=!1,p=r._checkReplyArgs,u=r._popOptions,c=r._popReplyAndTimeout,f=r._wrapError,m=r._unwrapError,y=r.ErrorTimeout,g=r.ErrorInterrupt;function T(e,n,r,t){let i,o=`${n}:${l++}`;return-1!==t&&(i=setTimeout(()=>{let n=a[o];n&&(delete a[o],n.callback(new y(e,o,t)))},t)),a[o]={sessionId:o,timeoutId:i,callback:r},o}function b(e){let n=a[e];return n&&(delete a[n.sessionId],n.timeoutId&&clearTimeout(n.timeoutId)),n}e.option=r.option,e.sendToAll=function(e,...n){if("string"!=typeof e)return t.error("Call to `sendToAll` failed. The message must be a string."),void 0;o.send.apply(o,["editor:ipc-renderer2all",e,...n])},e.sendToWins=function(e,...n){if("string"!=typeof e)return t.error("Call to `sendToWins` failed. The message must be a string."),void 0;o.send.apply(o,["editor:ipc-renderer2wins",e,...n])},e.sendToMainSync=function(e,...n){return"string"!=typeof e?(t.error("Call to `sendToMainSync` failed. The message must be a string."),void 0):o.sendSync.apply(o,[e,...n])},e.sendToMain=function(n,...r){if("string"!=typeof n)return t.error("Call to `sendToMain` failed. The message must be a string."),void 0;let i,l=c(r,d);return l?(i=T(n,`${s}@renderer`,l.reply,l.timeout),r=["editor:ipc-renderer2main",n,...r,e.option({sessionId:i,waitForReply:!0,timeout:l.timeout})]):r=[n,...r],o.send.apply(o,r),i},e.sendToPackage=function(n,r,...t){return e.sendToMain.apply(null,[`${n}:${r}`,...t])},e.sendToPanel=function(n,r,...i){if("string"!=typeof r)return t.error("Call to `sendToPanel` failed. The sent message must be a string."),void 0;let s,l=c(i,d);return l?(s=T(r,`${n}@renderer`,l.reply,l.timeout),i=["editor:ipc-renderer2panel",n,r,...i,e.option({sessionId:s,waitForReply:!0,timeout:l.timeout})]):i=["editor:ipc-renderer2panel",n,r,...i],o.send.apply(o,i),s},e.sendToMainWin=function(e,...n){if("string"!=typeof e)return t.error("Call to `sendToMainWin` failed. The message must be a string."),void 0;o.send.apply(o,["editor:ipc-renderer2mainwin",e,...n])},e.cancelRequest=function(e){b(e)},Object.defineProperty(e,"debug",{enumerable:!0,get:()=>d,set(e){d=e}}),e._closeAllSessions=function(){let e=Object.keys(a);for(let n=0;n<e.length;++n){let r=e[n],t=b(r);t.callback&&t.callback(new g(r))}},o.on("editor:ipc-main2panel",(n,r,o,...s)=>{let l=u(s);if(l&&l.waitForReply){let r=n.sender,i=o;n.reply=function(...n){d&&!p(n)&&t.warn(`Invalid argument for event.reply of "${i}": the first argument must be an instance of Error or null`);let o=e.option({sessionId:l.sessionId});return n=["editor:ipc-reply",...n,o],r.send.apply(r,n)}}s=[r,o,n,...s],i._dispatch.apply(i,s)}),o.on("editor:ipc-main2renderer",(n,r,...i)=>{!1===function(n,r,...i){if(0===i.length)return o.emit(r,n);let s=u(i);if(s&&s.waitForReply){let i=n.sender,o=r;n.reply=function(...n){!1===f(n)&&t.warn(`Invalid argument for event.reply of "${o}": the first argument must be an instance of Error or null`);let r=e.option({sessionId:s.sessionId});return n=["editor:ipc-reply",...n,r],i.send.apply(i,n)}}return i=[r,n,...i],o.emit.apply(o,i)}.apply(null,[n,r,...i])&&t.failed(`Message "${r}" from main to renderer failed, no response was received.`)}),o.on("editor:ipc-reply",(e,...n)=>{let r=u(n),t=m(n);if(t){let e=t.stack.split("\n");e.shift();let r=new Error(t.message);r.stack+="\n\t--------------------\n"+e.join("\n"),r.code=t.code,r.code=t.code,r.errno=t.errno,r.syscall=t.syscall,n[0]=r}let i=b(r.sessionId);i&&i.callback.apply(null,n)});